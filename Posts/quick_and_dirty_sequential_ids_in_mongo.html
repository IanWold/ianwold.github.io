

	


<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="../bundle.min.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		
			<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&display=swap&text=ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789" rel="stylesheet">
			<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600&family=Source+Code+Pro:wght@400&family=Vollkorn:wght@700&display=swap" rel="stylesheet">
		

		<title>
			Ian Wold | Quick & Dirty Sequential IDs in MongoDB 
		</title>

		
			<script type="application/ld+json">
				
			</script>
		
	</head>
	<body>
		<button id="dark-mode-toggle"><i data-feather="sun"></i></button>

		<nav class="content">
			<div class="headshot">
				<img src="../images/hero1.svg" width="150" height="154.41" />
			</div>
			<div class="title">
				<a href="../index.html">Ian Wold</a>
			</div>
			<ul>
				<li><a href="../about.html">About</a></li>
				<li><a href="https://buttondown.email/ianwold" target="_blank">Newsletter</a></li>
			</ul>
		</nav>
		
		




<header class="content">
	<h1>Quick & Dirty Sequential IDs in MongoDB</h1>
	<small>
		<span class="date">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> 1 November 2023
		</span>
		<span class="time">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> 8  Minutes 
		</span>
	</small>
	<p>Mongo doesn't natively support generating sequential IDs. Here's a quick & dirty solution to get you up and going if you need sequential IDs.</p>
</header>

<div class="content hero">
	<img src="https://images.unsplash.com/photo-1534078362425-387ae9668c17?w=1000&h=525&fit=crop&crop=entropy" />
</div>

<div class="content">
	
	<div class="post">
		<p>That Mongo doesn't natively support sequential IDs is one of the many knocks against it. Sure, you <em>should</em> be using GUID IDs in Mongo, but suppose you're working on a microservices conversion and you have a legacy mainframe that needs to be able to know what your objects are? If you're content just using Atlas, you can create a counter collection and add a trigger for auto-incrementing IDs <a href="https://www.mongodb.com/basics/mongodb-auto-increment">fairly easily</a>.</p>
<p>Suppose however that you can't use a pure Atlas solution - you'll need to implement this logic yourself in your own code. If you happen to be working in a microservices environment you have concurrency concerns - there might be multiple shards of your database and/or multiple replicas of your microservice.</p>
<p>Is a primary key generator really the sort of thing you want &quot;quick and dirty&quot;? Probably not. Am I doing it in prod? Yes.</p>
<h1>Updating a counter collection</h1>
<p>As a prerequisite, ensure you have the Mongo driver:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-plaintext"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F8F8F2;">go get go.mongodb.org/mongo-driver/mongo</span></div><textarea data-torchlight-original="true" style="display: none !important;">go get go.mongodb.org/mongo-driver/mongo
</textarea></code></pre>
<p>Just as Mongo's tutorial for Atlas recommends, we'll implement a counter collection. This collection will contain one document per &quot;kind&quot; of ID we need to generate. If you have just one object that needs sequential IDs, then you'll only have one document in this collection. We'll represent this collection document with a struct. It only needs one field, <code>sequence</code>, which will represent the latest ID generated:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoCounterDocument</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    sequence </span><span style="color: #66D9EF;">int</span><span style="color: #F8F8F2;"> </span><span style="color: #E6DB74;">`bson:&quot;sequence&quot;`</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">type MongoCounterDocument struct {
    sequence int `bson:"sequence"`
}
</textarea></code></pre>
<p>The ID of each document in the collection should be a string you hardcode or keep in a settings file (such as <code>&quot;personIdCounter&quot;</code>), and doesn't need to be in the document struct. Instead, we'll encapsulate that in a generator struct along with a reference to the collection:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoIdGenerator</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    counterCollection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection</span></div><div class='line'><span style="color: #F8F8F2;">    counterDocumentId </span><span style="color: #66D9EF;">string</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">type MongoIdGenerator struct {
    counterCollection *mongo.Collection
    counterDocumentId string
}
</textarea></code></pre>
<p>To implement the functionality to generate the next ID, we'll use the <code>FindOneAndUpdate</code> operation to increment <code>sequence</code> and return the new ID to us. We can specify a couple options here: we can upsert the document so that it will be created automatically if one isn't there for us (useful for integration tests), and we can specify that we want the operation to read and return us a copy of the document <em>after</em> the update has taken place.</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">func</span><span style="color: #F8F8F2;"> (generator </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">MongoIdGenerator) </span><span style="color: #A6E22E;">GetNextId</span><span style="color: #F8F8F2;">() (</span><span style="color: #66D9EF;">int</span><span style="color: #F8F8F2;">, </span><span style="color: #66D9EF;">error</span><span style="color: #F8F8F2;">) {</span></div><div class='line'><span style="color: #F8F8F2;">    filter </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;_id&quot;</span><span style="color: #F8F8F2;">: m.counterDocumentId}</span></div><div class='line'><span style="color: #F8F8F2;">    update </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;$inc&quot;</span><span style="color: #F8F8F2;">: bson.</span><span style="color: #66D9EF;">M</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;sequence&quot;</span><span style="color: #F8F8F2;">: </span><span style="color: #AE81FF;">1</span><span style="color: #F8F8F2;">)}</span></div><div class='line'><span style="color: #F8F8F2;">    options </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> options.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">().</span><span style="color: #66D9EF;">SetUpsert</span><span style="color: #F8F8F2;">(</span><span style="color: #AE81FF;">true</span><span style="color: #F8F8F2;">).</span><span style="color: #66D9EF;">SetReturnDocument</span><span style="color: #F8F8F2;">(options.After)</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">var</span><span style="color: #F8F8F2;"> updatedDocument MongoIdCounter</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    err </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> m.counterCollection.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">(context.</span><span style="color: #66D9EF;">TODO</span><span style="color: #F8F8F2;">(), filter, update, options).</span><span style="color: #66D9EF;">Decode</span><span style="color: #F8F8F2;">(</span><span style="color: #F92672;">&amp;</span><span style="color: #F8F8F2;">updatedDocument)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">if</span><span style="color: #F8F8F2;"> err </span><span style="color: #F92672;">!=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">nil</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">0</span><span style="color: #F8F8F2;">, errors.</span><span style="color: #66D9EF;">New</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;Unable to update Mongo id counter collection.&quot;</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> updatedDocument.sequence, </span><span style="color: #AE81FF;">nil</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">func (generator *MongoIdGenerator) GetNextId() (int, error) {
    filter := bson.M{"_id": m.counterDocumentId}
    update := bson.M{"$inc": bson.M("sequence": 1)}
    options := options.FindOneAndUpdate().SetUpsert(true).SetReturnDocument(options.After)

    var updatedDocument MongoIdCounter

    err := m.counterCollection.FindOneAndUpdate(context.TODO(), filter, update, options).Decode(&amp;updatedDocument)
    if err != nil {
        return 0, errors.New("Unable to update Mongo id counter collection.")
    }

    return updatedDocument.sequence, nil
}
</textarea></code></pre>
<p><code>FindOneAndUpdate</code> is atomic and shouldn't have any concurrency concerns so long as you <strong>do not shard the counter collection</strong>.</p>
<h1>But I don't want to have to hit Mongo every time I want a new id</h1>
<p>Huh, you and I think alike, I didn't either! To get around this, we can have our app generate multiple IDs each time it hits Mongo and use these IDs until it runs out locally.</p>
<p>With this approach you have the concern that if your app is spinning up and tearing down too frequently, you'll start losing IDs in the mix. There are various strategies to mitigate this, such as retrieving a small number of IDs from Mongo each time or persisting the cache of IDs, but I'm not going to get into those here.</p>
<p>We'll add <code>nextId</code> and <code>maxId</code> properties to the generator object, as well as an increment field to specify how many IDs we should generate each time:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoIdGenerator</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    counterCollection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection</span></div><div class='line'><span style="color: #F8F8F2;">    counterDocumentId </span><span style="color: #66D9EF;">string</span></div><div class='line'><span style="color: #F8F8F2;">    incrementBy       </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    nextId            </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    maxId             </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">type MongoIdGenerator struct {
    counterCollection *mongo.Collection
    counterDocumentId string
    incrementBy       int
    nextId            int
    maxId             int
}
</textarea></code></pre>
<p>We'll add a func to instantiate this at startup. It'll be important that your app only has one of these objects per &quot;kind&quot; of ID you need to generate:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">func</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">SetupMongoIdGenerator</span><span style="color: #F8F8F2;">(collection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection, documentId </span><span style="color: #66D9EF;">string</span><span style="color: #F8F8F2;">) </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">MongoIdGenerator {</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> $MongoIdGenerator{</span></div><div class='line'><span style="color: #F8F8F2;">        counterCollection   : collection,</span></div><div class='line'><span style="color: #F8F8F2;">        counterDocumentId   : documentId,</span></div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #88846F;">// Adjust this up or down depending on how many IDs you want to generate at once:</span></div><div class='line'><span style="color: #F8F8F2;">        incrementBy         : </span><span style="color: #AE81FF;">25</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">        nextId              : </span><span style="color: #AE81FF;">0</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">        maxId               : </span><span style="color: #AE81FF;">0</span></div><div class='line'><span style="color: #F8F8F2;">    }</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">func SetupMongoIdGenerator(collection *mongo.Collection, documentId string) *MongoIdGenerator {
    return $MongoIdGenerator{
        counterCollection   : collection,
        counterDocumentId   : documentId,
        // Adjust this up or down depending on how many IDs you want to generate at once:
        incrementBy         : 25,
        nextId              : 0,
        maxId               : 0
    }
}
</textarea></code></pre>
<p>And we can update our <code>GetNextId</code> function to consult Mongo or not if <code>nextId</code> equals <code>maxId</code>:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">func</span><span style="color: #F8F8F2;"> (generator </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">MongoIdGenerator) </span><span style="color: #A6E22E;">GetNextId</span><span style="color: #F8F8F2;">() (</span><span style="color: #66D9EF;">int</span><span style="color: #F8F8F2;">, </span><span style="color: #66D9EF;">error</span><span style="color: #F8F8F2;">) {</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">if</span><span style="color: #F8F8F2;"> generator.nextId </span><span style="color: #F92672;">==</span><span style="color: #F8F8F2;"> generator.maxId {</span></div><div class='line'><span style="color: #F8F8F2;">        filter </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;_id&quot;</span><span style="color: #F8F8F2;">: m.counterDocumentId}</span></div><div class='line'><span style="color: #F8F8F2;">        update </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;$inc&quot;</span><span style="color: #F8F8F2;">: bson.</span><span style="color: #66D9EF;">M</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;sequence&quot;</span><span style="color: #F8F8F2;">: generator.incrementBy)}</span></div><div class='line'><span style="color: #F8F8F2;">        options </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> options.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">().</span><span style="color: #66D9EF;">SetUpsert</span><span style="color: #F8F8F2;">(</span><span style="color: #AE81FF;">true</span><span style="color: #F8F8F2;">).</span><span style="color: #66D9EF;">SetReturnDocument</span><span style="color: #F8F8F2;">(options.After)</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #F92672;">var</span><span style="color: #F8F8F2;"> updatedDocument MongoIdCounter</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        err </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> m.counterCollection.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">(context.</span><span style="color: #66D9EF;">TODO</span><span style="color: #F8F8F2;">(), filter, update, options).</span><span style="color: #66D9EF;">Decode</span><span style="color: #F8F8F2;">(</span><span style="color: #F92672;">&amp;</span><span style="color: #F8F8F2;">updatedDocument)</span></div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #F92672;">if</span><span style="color: #F8F8F2;"> err </span><span style="color: #F92672;">!=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">nil</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">            </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">0</span><span style="color: #F8F8F2;">, errors.</span><span style="color: #66D9EF;">New</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;Unable to update Mongo id counter collection.&quot;</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        generator.nextId </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> updatedDocument.sequence </span><span style="color: #F92672;">-</span><span style="color: #F8F8F2;"> incrementBy</span></div><div class='line'><span style="color: #F8F8F2;">        generator.maxId </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> updatedDocument.sequence</span></div><div class='line'><span style="color: #F8F8F2;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    generator.nextId </span><span style="color: #F92672;">+=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">1</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> generator.nextId, </span><span style="color: #AE81FF;">nil</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">func (generator *MongoIdGenerator) GetNextId() (int, error) {
    if generator.nextId == generator.maxId {
        filter := bson.M{"_id": m.counterDocumentId}
        update := bson.M{"$inc": bson.M("sequence": generator.incrementBy)}
        options := options.FindOneAndUpdate().SetUpsert(true).SetReturnDocument(options.After)

        var updatedDocument MongoIdCounter

        err := m.counterCollection.FindOneAndUpdate(context.TODO(), filter, update, options).Decode(&amp;updatedDocument)
        if err != nil {
            return 0, errors.New("Unable to update Mongo id counter collection.")
        }

        generator.nextId = updatedDocument.sequence - incrementBy
        generator.maxId = updatedDocument.sequence
    }

    generator.nextId += 1
    return generator.nextId, nil
}
</textarea></code></pre>
<p>We do have a concurrency concern here though - we want to ensure <code>nextId</code> and <code>maxId</code> are only being accessed one at a time. We can use a mutex in the generator for this. Update the generator:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoIdGenerator</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    counterCollection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection</span></div><div class='line'><span style="color: #F8F8F2;">    counterDocumentId </span><span style="color: #66D9EF;">string</span></div><div class='line'><span style="color: #F8F8F2;">    incrementBy       </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    nextId            </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    maxId             </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    mutex             sync.Mutex</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">type MongoIdGenerator struct {
    counterCollection *mongo.Collection
    counterDocumentId string
    incrementBy       int
    nextId            int
    maxId             int
    mutex             sync.Mutex
}
</textarea></code></pre>
<p>And add the following two to the beginning of <code>GetNextId</code>:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F8F8F2;">generator.mutex.</span><span style="color: #66D9EF;">Lock</span><span style="color: #F8F8F2;">()</span></div><div class='line'><span style="color: #F92672;">defer</span><span style="color: #F8F8F2;"> generator.mutex.</span><span style="color: #66D9EF;">Unlock</span><span style="color: #F8F8F2;">()</span></div><textarea data-torchlight-original="true" style="display: none !important;">generator.mutex.Lock()
defer generator.mutex.Unlock()
</textarea></code></pre>
<p>That should be that! Here's the final code all together:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-go"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoCounterDocument</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    sequence </span><span style="color: #66D9EF;">int</span><span style="color: #F8F8F2;"> </span><span style="color: #E6DB74;">`bson:&quot;sequence&quot;`</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F92672;">type</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">MongoIdGenerator</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">struct</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">    counterCollection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection</span></div><div class='line'><span style="color: #F8F8F2;">    counterDocumentId </span><span style="color: #66D9EF;">string</span></div><div class='line'><span style="color: #F8F8F2;">    incrementBy       </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    nextId            </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    maxId             </span><span style="color: #66D9EF;">int</span></div><div class='line'><span style="color: #F8F8F2;">    mutex             sync.Mutex</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F92672;">func</span><span style="color: #F8F8F2;"> </span><span style="color: #A6E22E;">SetupMongoIdGenerator</span><span style="color: #F8F8F2;">(collection </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">mongo.Collection, documentId </span><span style="color: #66D9EF;">string</span><span style="color: #F8F8F2;">) </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">MongoIdGenerator {</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> $MongoIdGenerator{</span></div><div class='line'><span style="color: #F8F8F2;">        counterCollection   : collection,</span></div><div class='line'><span style="color: #F8F8F2;">        counterDocumentId   : documentId,</span></div><div class='line'><span style="color: #F8F8F2;">        incrementBy         : </span><span style="color: #AE81FF;">25</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">        nextId              : </span><span style="color: #AE81FF;">0</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">        maxId               : </span><span style="color: #AE81FF;">0</span></div><div class='line'><span style="color: #F8F8F2;">    }</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F92672;">func</span><span style="color: #F8F8F2;"> (generator </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;">MongoIdGenerator) </span><span style="color: #A6E22E;">GetNextId</span><span style="color: #F8F8F2;">() (</span><span style="color: #66D9EF;">int</span><span style="color: #F8F8F2;">, </span><span style="color: #66D9EF;">error</span><span style="color: #F8F8F2;">) {</span></div><div class='line'><span style="color: #F8F8F2;">    generator.mutex.</span><span style="color: #66D9EF;">Lock</span><span style="color: #F8F8F2;">()</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">defer</span><span style="color: #F8F8F2;"> generator.mutex.</span><span style="color: #66D9EF;">Unlock</span><span style="color: #F8F8F2;">()</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">if</span><span style="color: #F8F8F2;"> generator.nextId </span><span style="color: #F92672;">==</span><span style="color: #F8F8F2;"> generator.maxId {</span></div><div class='line'><span style="color: #F8F8F2;">        filter </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;_id&quot;</span><span style="color: #F8F8F2;">: m.counterDocumentId}</span></div><div class='line'><span style="color: #F8F8F2;">        update </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> bson.M{</span><span style="color: #E6DB74;">&quot;$inc&quot;</span><span style="color: #F8F8F2;">: bson.</span><span style="color: #66D9EF;">M</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;sequence&quot;</span><span style="color: #F8F8F2;">: generator.incrementBy)}</span></div><div class='line'><span style="color: #F8F8F2;">        options </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> options.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">().</span><span style="color: #66D9EF;">SetUpsert</span><span style="color: #F8F8F2;">(</span><span style="color: #AE81FF;">true</span><span style="color: #F8F8F2;">).</span><span style="color: #66D9EF;">SetReturnDocument</span><span style="color: #F8F8F2;">(options.After)</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #F92672;">var</span><span style="color: #F8F8F2;"> updatedDocument MongoIdCounter</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        err </span><span style="color: #F92672;">:=</span><span style="color: #F8F8F2;"> m.counterCollection.</span><span style="color: #66D9EF;">FindOneAndUpdate</span><span style="color: #F8F8F2;">(context.</span><span style="color: #66D9EF;">TODO</span><span style="color: #F8F8F2;">(), filter, update, options).</span><span style="color: #66D9EF;">Decode</span><span style="color: #F8F8F2;">(</span><span style="color: #F92672;">&amp;</span><span style="color: #F8F8F2;">updatedDocument)</span></div><div class='line'><span style="color: #F8F8F2;">        </span><span style="color: #F92672;">if</span><span style="color: #F8F8F2;"> err </span><span style="color: #F92672;">!=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">nil</span><span style="color: #F8F8F2;"> {</span></div><div class='line'><span style="color: #F8F8F2;">            </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">0</span><span style="color: #F8F8F2;">, errors.</span><span style="color: #66D9EF;">New</span><span style="color: #F8F8F2;">(</span><span style="color: #E6DB74;">&quot;Unable to update Mongo id counter collection.&quot;</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">        generator.nextId </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> updatedDocument.sequence </span><span style="color: #F92672;">-</span><span style="color: #F8F8F2;"> incrementBy</span></div><div class='line'><span style="color: #F8F8F2;">        generator.maxId </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> updatedDocument.sequence</span></div><div class='line'><span style="color: #F8F8F2;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F8F8F2;">    generator.nextId </span><span style="color: #F92672;">+=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">1</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">return</span><span style="color: #F8F8F2;"> generator.nextId, </span><span style="color: #AE81FF;">nil</span></div><div class='line'><span style="color: #F8F8F2;">}</span></div><textarea data-torchlight-original="true" style="display: none !important;">type MongoCounterDocument struct {
    sequence int `bson:"sequence"`
}

type MongoIdGenerator struct {
    counterCollection *mongo.Collection
    counterDocumentId string
    incrementBy       int
    nextId            int
    maxId             int
    mutex             sync.Mutex
}

func SetupMongoIdGenerator(collection *mongo.Collection, documentId string) *MongoIdGenerator {
    return $MongoIdGenerator{
        counterCollection   : collection,
        counterDocumentId   : documentId,
        incrementBy         : 25,
        nextId              : 0,
        maxId               : 0
    }
}

func (generator *MongoIdGenerator) GetNextId() (int, error) {
    generator.mutex.Lock()
    defer generator.mutex.Unlock()

    if generator.nextId == generator.maxId {
        filter := bson.M{"_id": m.counterDocumentId}
        update := bson.M{"$inc": bson.M("sequence": generator.incrementBy)}
        options := options.FindOneAndUpdate().SetUpsert(true).SetReturnDocument(options.After)

        var updatedDocument MongoIdCounter

        err := m.counterCollection.FindOneAndUpdate(context.TODO(), filter, update, options).Decode(&amp;updatedDocument)
        if err != nil {
            return 0, errors.New("Unable to update Mongo id counter collection.")
        }

        generator.nextId = updatedDocument.sequence - incrementBy
        generator.maxId = updatedDocument.sequence
    }

    generator.nextId += 1
    return generator.nextId, nil
}
</textarea></code></pre>

	</div>
	<div class="comments">
		<script src="https://giscus.app/client.js"
			data-repo="IanWold/ianwold.github.io"
			data-repo-id="MDEwOlJlcG9zaXRvcnkxNTk1NDkyNzI="
			data-category="Posts"
			data-category-id="DIC_kwDOCYKHWM4CZH2Y"
			data-mapping="title"
			data-strict="0"
			data-reactions-enabled="0"
			data-emit-metadata="0"
			data-input-position="top"
			data-theme="light"
			data-lang="en"
			data-loading="lazy"
			crossorigin="anonymous"
			async>
		</script>
	</div>
</div>

<div class="section-gray">
	<div class="content post-end">
		<img src="../images/hero1.svg" />
		<div class="bio">
			<h1>Hi, I'm Ian</h1>
			<p>
				I'm a software engineer, architect, and team leader in Minneapolis. My career has largely focused on .NET and web technologies, spread across several industries. Currently I'm working for Crate &amp; Barrel on their ecommerce solutions. You can find me on this blog, contributing to open source repositories, and at conferences around the Midwest.
			</p>
			<hr/>
			<p>
				If you'd like to keep up with me, please subscribe to my <a href="https://buttondown.email/ianwold" target="_blank">newsletter</a> or <a href="https://ian.wold.guru/feed.xml" target="_blank">RSS feed</a>. If you'd like to help me out with server costs, I would be forever grateful if you <a href="https://ko-fi.com/ianwold">bought me a coffee</a>!
			</p>
			<hr/>
			<p>
				Some other posts you might be interested in:
			</p>
			<div class="archive">
				<ul>
					
						<li>
							<a href="../Posts/deploying_aspdotnet_7_projects_with_railway.html">
								Deploying ASP.NET 7 Projects with Railway<small>Railway is a startup cloud infrastructure provider that has gained traction for being easy to use and cheap for hobbyists. Let's get a .NET 7 Blazor WASM app up and running with it!</small>
							</a>
						</li>
					
						<li>
							<a href="../Posts/giscus_is_awesome.html">
								Giscus is Awesome<small>I can add comments to my statically generated blog? Using GitHub Discussions?? For Free??? And it works????</small>
							</a>
						</li>
					
				</ul>
			</div>
		</div>
	</div>
</div>


		<footer>
			<div class="content content-footer">
				<span>
					Copyright &copy; Ian Wold. Built with <a href="https://www.github.com/IanWold/Metalsharp">Metalsharp</a>, <a href="https://torchlight.dev">Torchlight</a>, and <a href="https://feathericons.com/">Feather</a>. Hosted with <a href="https://www.github.com/IanWold/ianwold.github.io">GitHub Pages</a>.
				</span>
				<div class="icon-links">
					<a href="https://github.com/ianwold"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
					<a href="mailto:ian@wold.guru?subject=Hello"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a>
					<a href="https://ko-fi.com/ianwold" target="_blank"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-coffee"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></a>
					<a href="https://buttondown.email/ianwold" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></a>
					<a href="https://ian.wold.guru/feed.xml" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
				</div>
			</div>
		</footer>

		<script>
			
				window.addEventListener('DOMContentLoaded', () => {
					const observer = new IntersectionObserver(entries => {
						entries.forEach(entry => {
							const id = entry.target.getAttribute('id');
							let classList = document.querySelector(`.pane li a[href="#${id}"]`).parentElement.classList;

							if (entry.intersectionRatio > 0) {
								classList.add('active');
							} else {
								classList.remove('active');
							}
						});
					});

					document.querySelectorAll('section[id]').forEach((section) => {
						observer.observe(section);
					});
				});
			

			const darkModeToggle = document.getElementById("dark-mode-toggle");
			const body = document.body;

			function toggleDarkMode() {
				body.classList.toggle("dark");

				if (localStorage.getItem("dark") === "enabled") {
					localStorage.setItem("dark", "disabled");
				} else {
					localStorage.setItem("dark", "enabled");
				}
			}

			darkModeToggle.addEventListener("click", toggleDarkMode);

			if (localStorage.getItem("dark") === "enabled") {
				body.classList.toggle("dark");
			}
		</script>
	</body>
</html>
