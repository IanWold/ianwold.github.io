

	


<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta charset="UTF-8">
		<meta name="description" content="Ian Wold is a Software Engineer, Architect, and Team Leader in Minneapolis.">
		<meta name=”robots” content="index, follow">
		<meta name="google-site-verification" content="bnAFrga8yOgj-ZnQFrYEjV-geaJn-WHjeDg6WZkzoAc" />
		<meta name="msvalidate.01" content="3BFFA0F7DF4045C0DF2CBCB917387111" />

		<link rel="stylesheet" href="../site.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		
			<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&display=swap&text=ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789" rel="stylesheet">
			<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600&family=Source+Code+Pro:wght@400&family=Vollkorn:wght@300;700&display=swap" rel="stylesheet">
		

		<link rel="webmention" href="https://webmention.io/ian.wold.guru/webmention" />

		

		<title>
			Ian Wold | Postgres: Use Views to Refactor to Soft Delete 
		</title>

		
			<script type="application/ld+json">
				{
	"@context": "https://schema.org",
	"@type": "Article",
	"author": [{
		"@type": "Person",
		"name": "Ian Wold"
	}],
	"datePublished": "10/5/2024 12:00:00 AM",
	"image": "https://images.unsplash.com/photo-1560506839-a23b986135a0",
	"headline": "Postgres: Use Views to Refactor to Soft Delete",
	"description": "Refactors are tough, database refactors are scary. Being a bit clever can save us a lot of pain!",
	"publisher": {
		"@type": "Person",
		"name": "Ian Wold",
		"logo": {
			"@type": "ImageObject",
			"url": "https://ian.wold.guru/images/hero1.svg"
		}
	},
}
			</script>
		

		<script defer src="https://umami-production-2e18.up.railway.app/script.js" data-website-id="df5b434a-847c-4372-88d4-33bc64349044"></script>
	</head>
	<body>
		<button id="dark-mode-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button>

        <header>
            <svg xmlns="http://www.w3.org/2000/svg" id="hero" width="150" viewBox="0 0 605 579"><path d="m485 574-1-5-4-2c-8 0-11-7-6-13 2-3 8-4 8-2l6 1c7-1 9 1 6 6l-4 5c-2 2-3 3-2 8 1 7-1 8-3 2zm-3-11c2-2 2-7-1-7l-1-2c0-2-1-2-3 1-3 2-3 6-1 8s2 2 6 0zm8-3c3-2 2-5-1-5-2 0-3 1-3 4s2 4 4 1zm-166 15-13-2c-1 1-8-1-17-2-8-2-22-4-30-4l-32-4c-25-4-46-5-49-2h-3c-2-3-22-4-40-1l-15 1c-1-1 2-2 9-3l9-3c1-1 0-1-6-1h-7c-1-1-6-2-14-1-16 0-19 0-19-2l12-2h-5c-14 0-20 1-25 2-9 3-9 3-9 1v-2l-8 2c-8 2-10 2-10 1 0-2 16-5 40-7 27-3 29-4 26-5l-5-2 6-1 7-1-3-5c-4-3-10-13-10-16 0-4 2-2 4 3 1 3 2 4 2 2 1-4 3-2 3 3 0 3 1 5 4 7l3 3v-3c0-2-1-3-3-3-3 0-3-1-1-3 3-3 0-9-3-8s-5-2-3-4c2-3 9 1 9 6l2 5 3 5a8 8 0 0 0 5 4c4 1 2 4-2 3h-4c0 2 5 3 9 2 4-2 9-10 16-24l6-14-1-10a92 92 0 0 1-2-29v-7a34 34 0 0 0-6 8c-6 10-14 20-15 19l3-5 4-5 1-4v-4l1-3v-3c0-1-2 0-3 2a33 33 0 0 1-7 6c-2 1-4 4-5 8l-2 6-6 12a9825 9825 0 0 1-6 18c0 2-2 2-4 2-2-1-2-2 1-7 4-7 13-29 13-32a59 59 0 0 1 12-14c18-18 25-30 26-45 0-4-3-7-7-5-1 0-2 0-2-2l-6-2c-3 0-7 0-10-2l-9-2c-5 0-9-5-10-12l-2-6a24 24 0 0 0-8-5c-3-1-3-3-1-3v-2c-1-1-2-3-1-4l-4-7a55 55 0 0 1-7-9l-2-3v4l-2 8c-2 4-7 7-7 5l2-2 2-3c-1-1 0-3 1-5 1-4 1-4-2-8a23 23 0 0 1-3-7c-1-3-4-6-8-7-6-1-5-3 1-3l6 2 4 5 1-5v-5l1 5 3 10c3 4 10 12 12 12v-14c-2-4-2-4 2-5 3-1 3-1 3 3v2l2 1c0 3 3 4 6 3l2 1-6 1c-5-1-6 0-7 2-1 4 3 9 6 9l3 1c0 2-2 2-6 0h-1l3 4 4 4 4 3h14c4 0 4 0-1-5a24 24 0 0 0-8-6c-6-1-7-4-1-3 5 2 14 9 14 12s11 1 14-1l6-4c3-1 4-2 4-4s1-2 3-2l4-4c1-5 4-8 4-5l-1 2c-1 0-2 2-1 4 0 3 0 3 6-3 3-3 5-6 5-8 0-5-1-5-4-2-2 2-2 1 1-5a77 77 0 0 0 4-18c1-8 1-10-1-10l-2-1c1-2-6-5-14-6a193 193 0 0 1-34-6c-1-2 2-1 16 1l17 2 11 3c6 2 7 2 5-2-1-2-3-3-8-3-8 0-9-2-2-3h5l-6-2a99 99 0 0 0-47-2c-10 2-19 7-15 8a177 177 0 0 0 36 7c3-1 4 0 4 1l3 3c3 1-3 1-19 1-25 1-32 0-33-3-1-1 0-2 2-1 5 2 20 4 27 3l7-1-11-3a49 49 0 0 0-26-3c-3 1-4 1-3-1l-1-2-2 2-3 4c-2 2-3 3-2 4 1 3 3 2 4-1s2-2 1 4v8c0 2-8 4-12 4s-10-4-10-6c0-1-1-2-4-2-4 1-5 1-4 3 2 4 2 8 0 8l-1-2-3-6c-6-5-15-3-10 2l2 8c0 6-1 5-2-1 0-5-2-8-6-7-3 1-4 1-3 5 1 3 0 3-1 3s-2-1-2-3v-2l-2 3-5 3-5 2c-3 4-3-2 0-7 4-8 4-17 0-21l-4-4-4-1-4-2-3-1 3 7 2 8c-2 3 1 6 5 6 3 0 3 1 2 2-1 2-2 2-5 1-4-2-5-2-6 1s0 6 3 6l3 1c0 2-7 2-7 0-1-2-5 7-5 10l3 1 3 1-3 1c-3 0-3 1-3 4s-1 4-2 4c-1 1-1 1 1 2h12c1 1 2 1 3-1 2-2 4-3 4-1l-4 6-5 5h4l7-2 4 1-4 2c-3 0-3 1-2 2 3 2 7 1 6 0 0-1 0-2 2-2 5 0 15-8 15-12l1-3 2 2v3c2 0 9-5 10-6 5-6 9 1 6 10l-3 5-6 4-4 4 4 1c2 1 9 2 16 1 11 0 14 1 17 3l5 4c0 2 2 4 5 5s4 3 3 3l-8-3-12-4-7-3 3-1 7 1 4 1-4-2c-4-2-10-2-12-1l-9 2-10 2c-1 0-3 0-5-2a8 8 0 0 0-7-3c-4 1-5 0-2-2 1-1 2-2 1-5l-1-3-5 2a52 52 0 0 1-14 3c-10 1-10 1-15-3a26 26 0 0 1-7-9c-3-9-1-24 4-30 2-3 2-5-1-5-5 0-3-5 2-9 7-3 7-7 3-12-4-3-4-3-1-6s16-5 19-2l6 5c3 2 4 4 4 7l2 6c2 2 2 2 12-1a828 828 0 0 1 12-3h5c3 1 6 0 15-4a96 96 0 0 1 13-6l6-5c2-2 6-6 9-7l4-3-4-2c-5-2-12-2-13 1l-3 1c-2 0-2-1-1-4l2-4 1-6c0-4-2-6-8-13-6-6-7-7-5-8 2 0 3 1 6 4a58 58 0 0 0 31 23c1-1-4-14-7-19-2-3-5-8-8-10l-3-5c1-1-7-11-9-11-1 0-2-1-2-3l-6-4c-5-1-6-1-9 1l-3 6c1 2 0 5-1 7s-1 3 1 4 3 5 1 5l-16-8 1-4c2-1 2-1 0-5-3-4-2-5 5-3 4 1 5 1 9-3 8-8 13-7 24 4 6 6 8 7 13 7l9 2 6 2 7 1 7 2c3 1 4 0 3-1l-2-2c-1 1-2 0-2-1 0-2-3-3-7-2s-5-3 0-7l4-4 6 4c7 3 11 3 9 0v-4c1-2 1-2 4 0 2 2 4 2 4 1s-2-3-4-3c-4-2-4-3-2-12 0-3 0-10-2-17a401 401 0 0 1-7-33c0-4 0-5 2-4s6-3 6-7c0-3 4-3 4 1 0 2-3 6-5 7-2 0 0 13 1 13l1-1c0-2 12-5 16-4l6-1c1-1 2-1 3 1s10 3 16 1c3-1 8-9 12-21 2-8 2-10-1-7l-9 1a43 43 0 0 0-28 9c-6 5-8 5-8 0 0-4-3-7-8-6-6 0-8 2-8 7l-1 3-2-4c0-5 4-9 9-9l8-1 7-3 12-5 9-4v-10c1-9 1-10 2-8 2 2 3 2 6 0 3-1 3-2 3-4v-6c1-2 1-4-1-8-3-6-7-9-7-5l-2 3c-2 1-2 5 0 11v3l-3-6c-1-5-3-6-5-6s-1-1 2-3c3-1 5-4 5-5l2-3 6-4 5-3-2 3c-2 2 3 7 5 5 3-2 3-4 0-6-2-2-3-4-1-4l5 5 3 5c0-3 4-4 7-2 4 5 6 1 2-3a10 10 0 0 1-3-5l-1-4 2-1c1 0 2 1 2 3-1 3 7-2 8-6 1-3 1-2 1 4l-1 7-1-3c0-2-1-2-4 0-2 2-2 2-1 4 3 1 2 4 0 10-2 4-3 5-5 4-8 0-15 6-12 10l1 11 1 9c3 0 8-4 8-6a37 37 0 0 1 13-16c4-2 10-6 13-11l2-5-6-1c-4 0-6 0-4-1a124 124 0 0 1 26-2c2 1-4 3-8 3-3 0-3 1-3 3 1 2 0 4-3 7-6 6-8 10-7 12 0 2 1 2 4 0l5-4c3-3 4-2 4 1l1 1a7 7 0 0 1 3-3l2-6 4-10 3-8c-1-2-1-3 1-1l4 1 1 1 1 2 1 2h-2c-3-2-8 3-9 8l-1 7c-1 1 0 2 2 2l3 1 2 1c5 0 8 9 5 16-2 5-12 15-15 15-5 0-16 18-17 28l-1 6c-3 5 12 40 19 45 4 3 5 6 3 6a94 94 0 0 1-11-5l-10-5 3 10a73 73 0 0 0 5 13l3 9 3 10c3 6 1 9-4 8h-4c0 1 2 2 5 2 6 0 8 1 6 3-1 2-1 2 1 3 3 2 7 11 6 13l-1 3-1 3-1 2h2l6 1c2 0 4 0 3 1 0 2 10 8 14 8l14 5c15 6 27 8 53 7 15 0 24 2 30 6l10 6c6 3 8 5 14 15l4 4c2 1 4 2 4 4a14 14 0 0 0 4 5l1 5c-1 3 4 11 8 13 8 4 15 10 16 13 3 5 13 7 42 9 17 1 15 0 24 18a63 63 0 0 0 7 11c1 0 21-20 23-24 2-3 2-4-3-15a4138 4138 0 0 1-10-22l-4-11-21 1a367 367 0 0 0-32 2c-9 2-14 1-12 0 2-2 37-5 49-5s14 0 13-3a161 161 0 0 0-19-34c-3-3-4-5-3-6 3-1 11 11 19 27l7 16h27a90 90 0 0 0-4-14c-11-29-20-64-15-59l1 4a484 484 0 0 0 24 74 346 346 0 0 0 17 45c2 1 8-6 9-11 1-3 2-4 3-2 2 1-3 10-7 15-3 4-3 4 0 9l3 6-1 1-3-6c-3-6-2-7-13 7l-7 8 4 10c5 10 7 13 7 10l1-3v6c0 4-2 7-7 12-4 3-6 6-5 7 2 1 1 3-3 3s-3-2 4-11l8-8-4-11a107 107 0 0 0-6-11s-4 2-7 6l-12 13a57 57 0 0 0-5 7c0 3 11 24 13 24l5 4 4 2-3 2c-3 2-3 3-2 6 2 5 2 7-1 2l-2-5-4 5c-4 5-5 6-1 6 3 0 12 4 14 6l5 2c2 0 3 3 1 4-1 1-1 2 1 2 5 0 10 3 8 4h-2c-3-2-7-2-10 1s-5 1-1-3c2-3 2-3-2-2a137 137 0 0 0-40 19c-1 0-2 1-1 3 2 6 2 7-1 8-5 1-6 0-6-4 1-3 2-4-17 10-8 6-13 8-10 4a141 141 0 0 1 21-16c3-1 5-3 5-4l-7-1c-6-1-8 0-11 3s-4 2-2-2c3-4 18-6 21-3s2 0-2-7a165 165 0 0 0-5-8l-19 17a154 154 0 0 1-29 23c-4 1-4-3 0-5 10-4 39-30 36-32-4-1-30 15-46 30l-8 7c-3 0 0-4 4-7 4-4 5-4 2-5-2-1-3-2-2-4s-3 0-10 8c-7 7-13 12-16 13-7 2-4 3 10 4s21 2 20 4l-2 1a35 35 0 0 0-4-1c-2-1-2 0 1 1 2 0 2 2 2 2-2 3-13 7-24 9-15 3-18 2-4-1 18-4 18-5 0-5-12 0-15 0-14 2 2 2 2 7 0 5h-36c-3 1-4 2-4 4 1 3 0 3-11 3l-22-1zm32-2-5-2a223 223 0 0 0-47-1l16 2c15 2 36 2 36 1zm-33-9c1-1 1-1 0 0h-9c-5-1-6-1-4-2s1-1-2-1h-4c0-2-4-2-5 0h-8c-8-2-39-4-39-3l28 7c11 1 42 1 43-1zm32 1-22-2c0 2 6 2 17 2h5zm39 0c0-2-11-4-16-4-1 0-2 0-3 2 0 1-3 2-8 2l10 1 17-1zm-146-5c-10-2-17-3-18-1s13 4 22 4c6 0 6 0-4-3zm124 2c1-2-8-2-12 0-2 1 0 1 5 1l7-1zm63-3-7-2a327 327 0 0 1-12-1h-4l4 2 4 1c1 1 14 2 15 0zm-284-6-5 1h3l2-1zm280 1h-4c-2 1-1 1 1 1l3-1zm-153-2h-3 3zm125-6h3c3 0 16-8 14-9-3-1-2-3 1-3 2 1 5-6 5-13l-4-19a108 108 0 0 1-6-25l-1-5-3 4c-4 4-10 7-10 5l2-2 6-4 5-5-2-14c-1-10-2-13 0-14 1 0 2-10 0-13-2-4-5 0-6 9-2 9-5 21-7 20a26 26 0 0 1 2-8l4-14 1-6h-6l-5 3c-1 2-3 1-3-1l10-5c8-2 8-2 3-2h-4l6-2c7 0 11-4 6-6-2 0-2-1 0-3 3-3 2-6-1-5l-3-1 3-1c2 0 3-1 3-2 0-3-1-3-4-2-5 1-5 1-5 5l-1 3-1-3-2-4h-1c2-1 4-6 4-8-1-1-2-2-7-1l-7 1 4-1 9-3 5-2h2l3-1c4 0 6-1 6-4l-1-4c-1 0-2-2-2-5v-4l-1 5-4 6-1-2c2-3-3-2-4 1-1 1-2 2-3 0-1-1-5 0-17 3a666 666 0 0 1-17 5l-1 5c-1 6 1 7 10 4l8-2-8 3-10 3-1 7-1 3v-7l-3-1c-2 0-2-1 1-2l1-2-5 2c-3 3-4 3-4 2s2-3 5-4c4-2 4-3 5-8 1-12 4-23 7-30 2-5 2-6 4-3s3 5 0 3c-1-1-2 0-4 6l-3 12c-1 5 0 5 3 5l30-7v-4c0-3-1-4-8-4h-15l3-2c3-1 3-2 1-2l-2-1c0-2 0-2 5 0l8 1c8-2 6-11-6-24l-14-16a26 26 0 0 0-6-6l1 2 1 2c-1 1-2 0-3-2-3-4-8-5-16-2-7 3-26 5-26 3 0-1 4-3 9-3 10-2 20-5 11-4-4 1-7 0-7-2l4-1c7 2 5-1-2-3l-14-5-25-6c-3 0-9-1-13-3-6-1-8-2-10 0v5l-1-2-3-1c-3 0-5-2-3-3 1-1 2 0 2 1h1l2-1v-1a6 6 0 0 0-2-3l-9-5c-7-4-11-4-11 0h3c4-1 5 1 1 3-3 2-8 0-8-3-1-4-10-8-19-8h-8c0 1 14 7 17 7l11 7 9 7c7 2 9 4 8 11l-1 6 4-3c3-2 3-2 2 0-2 2-1 5 1 5 1 0 3-5 3-8l3-2c4-1 4 0 1 4l-1 4 2 2c1 2 1 2 4-2l5-3-5 7-9 12a25 25 0 0 1-4 7v-3l2-5c-2-2-6 7-6 13-1 7-2 7-4 0-1-3-6 1-5 4l-1 2c-4-1-2-5 2-8 3-1 5-3 5-4l3-6 5-7c1-4 1-4-2-5-5-1-10-4-10-5l-5-6a34 34 0 0 1-6-9l-5-7c-4-3-5-3-11-2l-6-1c1-2-7-5-13-5-5 0-3 2 4 4 6 1 9 3 6 6-1 1-3 0-7-1l-7-2h-3c-2-2-7 0-7 2l-4 3-6 5v16c1 11 0 14-2 21a63 63 0 0 1-17 25c-5 5-7 7-5 7 2 1 9 24 9 30l1 3 1 4 2 4c2 1 2 2 1 3-1 4 8 28 12 33l4 5c-1 1 0 5 2 8l4 11 5 16 6 29c3 13 4 16 6 16l3 1 11 1c6 0 11 1 11 2 1 2 3 1 8-3l5-3 3-6c3-7 6-10 9-7s1 5-1 3c-3-2-4 0-7 8l-2 6-3 4-2 3 30-1h30v-4l1-5c1-1 0-2-1-2-1-1 0-1 1-1 2 0 2-2 3-6 1-10 3-17 5-17a42 42 0 0 0 2-13c2-11 1-13-1-14v-4c1-1 1-2-1-4s-2-4 0-4 2-1 1-8c0-6-1-8-3-10l-2-4c2-1 3-7 1-7l-1-1c1-1-1-2-4-3h-6c0 1-3 1-9-1-10-3-14-4-15-1a409 409 0 0 1-46 2c-3 0-5 0-6 2-2 2-4 3-3 1l-1-2c-2-1 0-10 3-10 1 0 2-1 2-3l2-3v-1c-1-2-1-4 2-10l2-7-1-2-2-7c-4-5-5-18-2-18v3c-1 7 6 21 10 18a78 78 0 0 0 11-22l-2-4c-2-2-3-6 0-6l3-2c1-2 1-2 4 0 2 3 1 5-2 5s-3 0 0 7c3 5 3 7 2 9-2 4-1 4 3 6l4 2c0 1 2 0 3-2a123 123 0 0 0 13-21l12-24c2-2 2-5 1-5a5 5 0 0 1-1-4h2c1 1 2 1 3-1 2-2 1-3-1-3v-1l3 1a54 54 0 0 0 15 8l1-2 1-3 1 3c0 4 0 4 7 7 6 2 7 2 8 0 1-1 1-1 1 2l2 5c1 1 1 2-1 2-2 1-4 4-7 13l-7 20-2 7-10 3-15 6-6 2 6 1c4 1 10 0 18-2 12-2 16-1 9 2-3 1-4 2-2 2l9-2c10-1 10 2 1 3-4 0-7 2-7 3-1 1 0 2 9 1h10l-2 2c-4 0-1 17 4 23l3 4c-2 1 0 5 6 11l5 8c0 1 2 4 5 6l4 6 7 15c7 15 9 24 9 39 0 9 0 9 4 10l8-1c3-1 5-1 8 1 6 3 4 5-1 3s-10-1-11 3c-2 4-5 3-4-2l-2-1-3 4c0 3 1 4 3 4 4 1 11 0 11-1zm-162-16c2-2 3-3 2-6l-3-3-2-2h2c2 0 2 0 2-4l-2-7a13 13 0 0 1-2-7l-4-11c-7-10-11-20-10-28v-6c-2-1-2-3 0-3 3 1 5 8 5 14a42 42 0 0 0 7 21c2 3 6 11 10 25l4 11c2 3 2 5 0 6l-6 1c-5 0-5 0-3-1zm-14-67-1 2 1 1v-3zm81 67 4-1c3 0 6-4 5-6l-7-4-5-3c0-5-10-4-12 1-1 3-4 3-4 0-1-4-9-4-12-1l-4 2 6-8a679 679 0 0 0 35-37c1 1-4 8-14 18-11 12-15 17-15 19s6 3 10 1c6-3 8-3 12 1 1 2 5 4 7 5l6 5c1 3 1 4-2 6-4 3-11 5-10 2zm-49-2-2-5-3-7c-1-3-2-4-2-1-1 3-4-9-5-17l-2-8-8-26a57 57 0 0 0-4-12l-1-3v-4c-2-3-1-3 0-3s3 2 3 4a868 868 0 0 0 13 45l2 10 4 9 3 5 4-6 5-5c1 0 5-3 9-8 11-11 15-16 13-15h-2c0-2 15-13 16-12s-8 12-28 32a313 313 0 0 0-16 18l2 4c1 2 2 5 1 6s-1 1-2-1zm139-58 5-7c5-6 5-4 0 4-3 4-5 6-5 3zm-15-42c-1-1 3-6 5-6l-1 2c-3 3-1 4 6 2h5c-1 1-14 3-15 2zm-172-7c-5-9-6-12-5-14 0-2 1-1 3 3l3 9c4 4 3-15 0-21a71 71 0 0 0-22-23c-8-5-6-7 2-2a65 65 0 0 1 23 26c2 7 2 17 0 22l-2 4zm158 0 4-2a48 48 0 0 0 7-3l4-2-3 2c-4 3-12 6-12 5zm37-7 2-1 1 1-1 1-2-1zm-205-16a36 36 0 0 0-12-5l-10-5c-1-3 2-10 4-11 2 0 2 0 0 4-3 5-2 7 6 9 8 1 13 4 15 8 2 3 0 3-3 0zm177-28 2-2v1c-1 2-2 3-2 1zm-167-2c-1-2-1-3 1-3 2 1 4-1 5-5 1-2 1-2 1 1l-2 5c-3 3-3 3-5 2zm27-9 2-5c1-1 0-3-2-5-2-1-4-3-3-4s3 1 7 5c3 3 3 3 5-4 1-4-2-13-5-18-4-6-5-6-5-1l-2 4-1-5c1-6 0-7-11-16-6-6-8-7-13-7s-9-1-9-2c0-2 18-1 19 1l11 6 1-2c2 0 2 1 2 5 0 3 2 5 5 9a40 40 0 0 1 11 19l-3 15-5 5c-4 5-5 6-4 0zm12 1 7-4 7-2-3 2c-5 3-11 5-11 4zm-43-19-1-4c1-2 1-2 2 1s1 5-1 3zm117-24c0-3 2-6 4-7 3-2 3-2 1 2-3 3-3 3 1 3 3 0 3 1 2 2h-8zm-20-4 7-8c1 0 3 0 4 2 2 2 2 2-1 2l-5 1c-2 1-2 2 0 3 1 0 1 1-2 1l-3-1zm-60-5-6-2-2-1c-1-1 8 1 11 3 5 2 3 2-3 0zm52 0c-5-1-6-2-7-5l1-2 1 2 6 3a30 30 0 0 1 7 3c2 1-1 1-8-1zm-34-14c-2-2 0-3 2-1v2l-2-1zM116 546l-3-1c-2 0-2 0 0 1 3 2 3 2 3 0zm36 1a94 94 0 0 0-25-3c-7 2-3 3 11 3h14zm232-2c0-2-1-3-3-3s-3-1-4-3l-2-2-3 2c-2 3-6 4-6 2s3-4 8-7c6-3 7-3 6 2-1 4 1 4 3 0 5-10 3-30-3-43l-3-8-3 5c-2 3-4 7-4 10l-2 14a31 31 0 0 0-1 10 45 45 0 0 1-6 19l-1-3 4-18 3-15-4-4-1-1c5 4 6 3 6-3 0-3-1-5-2-5l-1 2c2 3-1 2-4 0-2-2-3-2-4-1-2 1-2 2 0 2l1 1h-2c-2-2-4-1-9 1s-7 2-8 1c-3-2-7 2-7 7l-2 7c-1 2-3 6-3 10-1 6-1 6 1 6h2l3 5 3 4 2 2 4 1c2 1 23 4 39 5 2 0 3-1 3-2zm-40-14 2-7c2-7 2-9-1-13-3-3-3-4-1-4s6 6 6 10l-2 8c-2 3-2 6-2 7l-1 1-1-2zm-130 11h-7c-2 1-1 1 3 1l4-1zm22 0h-3c-1 1-1 1 1 1s3 0 2-1zm9 0h-3c-1 1-1 1 1 1l2-1zm84 0c0 2 1 2 4 0 1-1 1-2-2-5-3-4-8-6-6-2l-2 4c-2 3-2 3 0 3h6zm-143-2c12-2 26-2 24-1-1 1-1 2 2 2s3-1 3-3c-1-2 0-3 1-3l2-2c0-5-5-32-8-42a281 281 0 0 1-5-17l-3-7-1-2c0-2-5-8-6-6s1 6 2 5 1 0 1 2-7 9-8 7c-2-1-6 4-6 8-1 2-2 3-3 2-2 0-3 1-3 3l-4 7c-6 7-6 10-4 19s2 12 1 12l-2-6-2-8c-1-2-6 5-6 9l-2 2-3 4-2 5-5 5-3 4h5c11-2 21-3 21-1l-3 1-2 1c1 2 8 1 19 0zm-17-7 8-6a445 445 0 0 0 12-8c4-2 8-3 8-1l-6 4-13 7c-7 5-9 6-9 4zm18-1 18-13c3 0 0 3-8 9-9 6-15 8-10 4zm10 9a11 11 0 0 0-5 0l2 1 3-1zm39-2-2-1-3 1c0 1 1 2 3 2l2-2zm-12-1-2-1-1 1 2 1c1 0 2 0 1-1zm208-11c1-3 3-5 4-5l4-4c2-4 5-5 9-5l3-2c0-3 7-9 11-10 3 0 5-2 7-6l7-7 7-6c2-4 2-4 0-7l-2-4-16 17a183 183 0 0 1-17 16c0-2 5-8 19-21 10-11 13-14 12-17-1-4-4-4-10 1-7 6-8 7-8 4l2-2c3 0 1-3-3-3-9-2-8-2-10 3-1 5-1 5-6 5l-9 3-4 4c-1 0 0-3 2-5 2-3 4-4 11-5 3-1 4-2 4-4 0-4 3-6 8-5 8 2 13 2 15-2 2-3 2-4-3-13a478 478 0 0 0-6-10l-18 17-18 16 17-19 17-17-5-7c-6-8-7-9-4-9l5 6a38 38 0 0 0 5 7l5-7 4-5c1 1-1 5-3 9l-3 7 5 9 7 9 9-10 17-19 10-12c1-1-2-7-7-15-6-11-8-13-11-13h-9c0 2 6 5 10 4 3 0 4 0 3 1-1 3-7 3-14 0a29 29 0 0 0-7-3 297 297 0 0 0-27-5 97 97 0 0 1-17-4 12 12 0 0 0-5-2c-3 0-3-1-3-4 0-2-1-5-3-7l-2-3 1 5 1 18 1 14c1 1 1 2-1 2-2 1-3 2-3 7a47 47 0 0 1-3 17 502 502 0 0 0 5 67 41 41 0 0 1 3 9l3 13v18l4-4zm18-1c4-4 4-4 2-7-3-6-11-2-9 4l-1 4c-2 0-2 1-2 2 2 2 6 1 10-3zm64 1-1-2-1 1 1 1h1zm-48-13 15-9a33 33 0 0 0 9-4c0-2-6-10-8-10l-4 5c-3 4-3 4-2 0 1-5-3-3-4 2-1 4-2 5-5 5-5 1-13 6-13 9l4 7a77 77 0 0 0 8-5zm54 0 21-11a63 63 0 0 0 13-7c0-2-11-6-16-6h-5l3-4 2-6-7 3c-5 3-6 4-4 5 4 3 6 11 3 14-3 2-4 0-2-3 1-2 1-3-1-6-4-6-6-6-18 3l-7 5 4 7 7 10 7-4zm-26-23a32 32 0 0 0-6-9l-3 3c-1 2-1 3 4 8l5 9c0 2 1 2 3 0s1-3-3-11zm14 2 3-3c-2 0-10 5-10 6s2 1 7-3zm5-6c11-4 31-13 31-15l-3-5c-2-2-4-2-10-1-8 0-9 0-10-2-2-3-7-4-7-2s-3 2-4-1c-2-3-4-2-12 8l-8 9 3 7c5 9 5 9 9 7a47 47 0 0 1 11-5zm-147 0-3-1-1 1 2 2c2 0 2-1 2-2zm-21 0-1-2-2 1 2 1h1zm-175-4-1-1-1 1 1 2 1-2zm200 0-3-3c-2-1-2-1-1 1l4 2zm132-24h-6l-1 3v3l-2-3c-1-2-3-4-7-5h-7c0 1 0 3 2 5l2 4 3-3 3-3-1 3-2 5v4l2 4 7-8 7-9zm-326 13v-1l-2 2c0 2 1 1 2-1zm372-2c1-1 0-1-1-1l-2 1 1 1 2-1zm-206-1-4-4c-4-2-5-3-5-1l4 4c3 2 5 2 5 1zm-166-9c-1-5-2-4-2 1 0 2 1 3 2 3v-4zm361 1c1-1-6-17-8-17l-2 2h-2l1-4c2-1 1-7-1-6-2 0-15 18-15 20s1 2 5 1c4 0 5 0 8 3 2 3 3 3 8 2l6-1zm-204-5c-1-1-1-1-1 2 0 2 0 3 1 1v-3zm169-2c6-1 6-1 15-13l7-10-4-7-4-8-9 7-25 30a26 26 0 0 0 12 3l8-2zm-157 1-4-4-5-3 4 4 5 3zm11-1c1-1-5-7-6-7v3c1 4 5 7 6 4zm-194-5-2 2c0 2 0 2 1 1s2-2 1-3zm185 1a3 3 0 0 0-2-1v1h2zm-173-6-1 2c0 2 1 2 1 1v-3zm368-20a65 65 0 0 0 11-14l-10-24-9 9-13 13-4 5 4 7c2 4 3 6 4 4 0-3 4-3 4 0a12 12 0 0 1-1 5c-2 2 0 9 2 9l12-13zm-211 10-2-1-1 1 3 1v-1zm-21-1a9 9 0 0 0-4-2v2l4 1c2 0 2 0 0-1zm34-4a28 28 0 0 0-1-5h-11l5 2c3 1 4 2 3 4 0 2 2 4 4 4v-5zm-83 0c-2-2-4-3-6-2-2 0-3 1-3 2l9 4h3l-3-4zm13-2-2-1c-2 0-2 0 0 1 2 2 2 2 2 0zm11 0c1 0 1-1-1-2-4-2-7-2-8 1 0 1 3 3 6 2l3-1zm22 0-2-1c-1 1-1 1 1 1 1 0 2 0 1-1zm-18-3c-4-2-7-2-3 0l4 2c2 0 1-1-1-2zm11 1-4-2c-2 0-2 0 0 2l4 1h3l-3-1zm24 0a8 8 0 0 0-4-2c-2 0-1 1 0 2h4zm18-8c-1-1-3-2-7-1l-12 1-4 1 12 1c10 0 11 0 11-2zm-95-4 2-7c-1-1-2-1-3 3-4 8-3 11 1 3zm59 2c2-1 2-1 0-1l-4 1v2l4-2zm21-3c1-2 1-2-5-1-9 1-12 2-11 3 3 1 14 0 16-2zm-153 1-1-2-1 2v1l2-1zm114-2 7-2c2 0 3-1 3-2-2-2-5-1-12 2-5 3-6 4-4 4l6-2zm23-2h-2c-1 1-1 1 1 1 1 0 2 0 1-1zm-50-9c6-8 6-8 3-12-1-2-2-2-5 5-4 8-6 17-4 15l6-8zm9 4c5-3 6-6 3-6l-9 8c-3 4-1 3 6-2zm47 4h-3c-1 0-1 1 1 1l2-1zm255-20-6-15a586 586 0 0 1-14-33c-1-2-27-5-27-3a703 703 0 0 0 17 41c0 2 1 2 4 0 4-3 5 0 2 2l-3 3 3 7 5 13 3 6 8-10 8-11zm-294 15h-2l-2 2h2l2-2zm-103-4c-1-2-1-2-2-1v3c2 3 3 2 2-2zm79-2 2-4-3 3a12 12 0 0 0-3 6c0 3 3 0 4-4zm-99 3 1-9-1-6c-3 0-4-3-1-4 2 0 3-2 3-2 0-3-7-1-11 2-1 2-4 2-8 2s-6 1-6 2c0 2 6 11 10 14 5 3 12 4 13 1zm142-8c0-2-1-2-5 1a2298 2298 0 0 1-7 4l-3 3 8-2c6-3 8-5 8-6zm1 8 2-2-4 2-2 2 4-2zm117 0v-4c-1-4-6-5-6-2l-1 5c-1 3 0 3 3 2l4-1zm5-7c0-2-1-3-2-3l-1 2v4c0 3 0 3 1 2l2-5zm-286 3-3-4-2-3c1-1-3-6-4-6-2 0 1 10 3 12 3 3 7 4 6 1zm150-2 10-6 5-3 6-7 15-33a56 56 0 0 0-13-4c-1 0-22 37-22 40l2-1c4-3 6-4 7-2 0 0-4 5-10 9l-9 10c1 1 2 1 9-3zm41-6c-1-1-5 1-11 3-14 7-14 7 0 3 7-3 12-5 11-6zm-162 4v-4c-1-2-1-2-2 0l-1 4c0 3 2 2 3 0zm162-10c3 0 5-2 8-14 6-17 5-22-6-22h-4l-12 23-11 23 11-5a81 81 0 0 1 14-5zm-151 6-2-7c0-3-1-4-2-3-3 3-4 7-2 6s2 0 2 2c0 3 1 4 2 4 2 0 2-1 2-2zm-28-10c2-1 1-1-4-1h-11c-8-2-9 0-3 2a20 20 0 0 0 18-1zm268-7c1-10-9-34-13-34l-2-3c0-2-2-3-3-3l-6-4a28 28 0 0 0-9-6c-5-1-5-1-4 1l11 14c9 12 13 14 11 7-1-1 0-2 1-2s2 1 1 5l1 1c1-1 6 11 6 15 0 2 1 3 3 3h3l-3 1c-5 2-4 13 0 12 2-1 3-3 3-7zm30 6-4-2c-3 0-3 1-2 2h6zm-293-4h3l6-2 5-4c0-1 0-2-9 2-7 2-17 4-25 4l-3 1c2 2 19 2 23-1zm280-2-3-1-2 1 3 2c2 0 3-1 2-2zm11 0c-1-2-5-5-7-5l7 7v-2zm-38-2-2-1-2 1 2 1 2-1zm-354-6-2-2v2c1 3 3 3 2 0zm366-6-2-4 1 4 1 6v4l1-4-1-6zm-393 5h-2c-1 1-1 1 1 1 1 0 2 0 1-1zm33-4c0-2-3-2-4 1 0 1 0 2 2 2l2-2zm-47 0-2-3c-2-3-2-3 0 1 1 3 2 4 2 2zm395-5-1-4v6l2 4-1-6zm-385 0c1-1 0-2-3-1-5 1-6 2-4 4 1 2 2 2 4 0l3-3zm32 0-1 2v1c1-1 2-2 1-3zm14-1c2-5 1-6-3-3l-2 5c2 4 3 3 5-2zm-60-9c-1-1-1 0-1 2s0 2 1 1v-3zm311-4c-5-2-8-3-8-1l5 2c7 2 8 2 3-1zm93 0-3-4c-3-1-3 0 0 4s5 4 3 0zm-215-10c0-4 0-5-1-4l-2 13 3-9zm-5 2h-1l-2 3c0 2 1 2 2 0a8 8 0 0 0 1-3zm94-12c-1 0-3 3-3 5l2-1 1-4zm-194-3c3-3 3-6 0-7s-8 2-8 5c0 4 3 5 8 2zm306 1-3-2c-3-1-3 0-2 1 2 2 6 3 5 1zm-31-1c-2-3-7-3-8-1 0 1 1 2 5 2l3-1zm-300-3-2-2c-2 0-2 1-2 2l2 1 2-1zm320-2c-4-3-11-7-16-7-7-1-5 0 7 5 11 5 14 5 9 2zm-115-5-3-3h-2l2 3c0 3 3 2 3 0zm84-1h3c0-1-7-2-15-2h-13l9 3c7 2 9 2 10 0l6-1zm-319-1-1 1 1 2v-3zm70-9c2-2 0-3-2 0-3 1-3 2-1 2s3-1 3-2zm-78-1a8 8 0 0 0-4-1l1 1h3zm174-1c1-1 0-2-3-2h-4c0 4 4 5 7 2zm-25-7c-2-2-4-1-3 1l3 1c2-1 2-1 0-2zm-46-1-4 1h2c3 0 3-1 2-1zm-7-2c1-2-1-1-4 1s-3 2 0 1l4-2zm43 1-3-1-3 1c1 2 6 1 6 0zm29 0c0-1-1-2-3-2-4-1-5 2-1 3s4 1 4-1zm-40-1h-7l5 2c3 0 4-1 2-2zm26-1-2-1v1l1 1 1-1zm46 0c-4-2-5-2-5 0l4 1c3 0 3 0 1-1zm-94-1v-2l-4 2c-2 1-2 1 0 1l4-1zm41 0-5-3-6-4c-1-3-6-4-16-3-6 1-13 3-13 5a77 77 0 0 0 25-1l13 7 2-1zm34-5 10-2c5 0 7-2 4-5-4-2-1-5 8-5 9-1 16-3 16-5l-2-7c-1-5-2-6-4-5-2 0-2 1-5-10-1-4-2-10-4-13l-3-7a174 174 0 0 0-6-12 57 57 0 0 1-5-11l-3-4a124 124 0 0 0-36-11l-8-2c-2-1-3 0-2 1l2 26c0 31 0 34 5 44 5 13 4 23-2 12l-5-13c-2-6-3-7-4-5s-2 3-4 3h-2c-1 1 5 9 13 18l6 6c0 3 7 7 16 8l9 1 6-2zm-72-9v-1c-2 0-6 3-6 4 0 2 5-1 6-3zm-3-2c6-3 18-4 24-1 4 2 6 2 4-1l-3-1-5-3a37 37 0 0 0-11-5l-11-4a5 5 0 0 0-3-1c-2 0-2 1-1 4v9l1 5 5-2zm122-7c-1-4-1-4-4-3l-2 4c0 2 0 3 3 3 3-1 3-1 2-4zm-102-17-1-1v2c1 2 2 1 1-1zm87-9-1 2c0 2 1 2 1 1v-3zm6-7c-1-4-4-6-4-3l5 9-1-5zm-84 3-1-1-2 2 2 1 1-2zm-91-1-2-2c-3-1-4-1-2 2 2 2 4 2 4 0zm151-31h-1v2l2 1-1-3zm9-8c-3-3-3-1-1 4 1 3 2 3 2 2 1-2 0-4-1-6zm12-4-2-3 4 10c1-1 0-3-2-7zm-21 2c0-2-1-2-3-2l-2 3 2 1c2 1 3 0 3-2zm-5-5-3-2c-3 0-3 0-1 1 2 2 4 2 4 1zm-23-4h-3c-1 0-1 1 1 1l2-1zm39-16-2 2-2 5 2-2 2-5zm-17 3 1-13c1-10 2-11 6-15l4-6-5 1c-3 2-5 4-8 11-4 9-6 20-5 23 1 2 6 1 7-1zm7-22-1-1-1 1v1l2-1zm41-32 2-5-3 4c-3 3-3 5-1 5l2-4zm-31 2c3-1 3-6 1-6-3 0-5 3-5 5s1 2 4 1zm-8-3-1-2-1 2v1l2-1zm-22-9c0-4 0-5-1-3-1 1 0 9 1 9v-6zm65-4c-1-2-4 0-3 2h3v-2zm-66-10h-1v2-2zm-3-8-3-2 4 6-1-4zm16 0c0-3 0-4-1-2l2 6-1-5zm168 492h9c2 1 0 1-5 1-4 0-6 0-4-1zm196-13c0-1 4-2 5 0l-2 1-3-1zm-9-1h2-2zm-122-2 6-2c3-1 4-1 2-2a9 9 0 0 0-5-1c-9 2-16 2-16 1l2-2 56-2a668 668 0 0 0 54-1l12-1 11 1v-6l-1-6-5 1c-5 0-6-1-1-3h6c3 1 4 3 4 7v6h7l26 3-40 1c-38 0-50 1-32 3 12 1 26 3 25 4l-15-2a386 386 0 0 0-96 1zm81-15h5c0 1-2 2-4 1-3 1-3 0-1-1zm-436-6c-4-3-6-7-3-9 3-1 7-1 7 1a2 2 0 0 1-2 2c-4 0-3 2 2 5 5 4 2 4-4 1zm5-4 1-2 2 2-1 1-2-1zm-8-9c0-1 4-2 5-1l1-3c0-2 1-3 3-3l3 1-1 1-2 3c0 3 0 3-4 3l-5-1zm36-8 2-2c2-2 2-2 1 0l-3 2zm451-25 2-3 4-6c1-3 2-4 3-3 1 3-3 10-7 12h-2zm10-15h3-3zm-17-6c3-6 5-8 6-8l1 1-6 8-1-1zm-465-78c-14-2-18-4-14-6 1-1 2-1 3 1 3 3 13 4 15 1 1-1 1-1 1 1 0 1 1 2 3 2 4 0 8 2 8 3 0 2-1 1-16-2zm-30-35 1-7c1-4 0-5-3-8-4-4-4-4-2-4 4 0 7 3 8 9a19 19 0 0 1-1 9c-2 4-5 4-3 1zm71-15 1-4c1-2 1-1 1 2-1 5-2 6-2 2zm-35-11c-3 0-3-4 1-6 3-2 3-2 3 0l-3 2v2h5l5 1c0 1-7 2-11 1zm51-11-9-4c0-1 1-1 11 1 16 5 14 6-2 3zm152-40c0-3 81-7 129-5l37 2c12 0 13 0 13 3a499 499 0 0 0-39-1 804 804 0 0 0-132 2c-6 1-8 1-8-1zm-39-44c3-2 23-3 23-1l-6 2h-13c-6 1-7 1-4-1zm-1-25c1-2 5-3 11-4 6 0 4 2-1 3a42 42 0 0 0-8 2c-2 1-2 1-2-1zm0-33 6-1c4 0 5 0 2 1-5 2-8 2-8 0zm1-102c-2-2-1-6 1-7 2 0 2-6-1-9v-3c1 0 3 2 4 5s3 5 4 5c2 0 2-1 0-5-2-1-2-3-1-3 3 0 1-3-5-8a26 26 0 0 0-7-4c-1 1 3 18 4 18l1 1-4 2c-3 0-4 0-3-2s0-3-2-3l-4-2-3-2c-2 0-6-9-5-13 1-2 0-3-1-4-3-1-2-2 1-2s3 1 4 6c0 4 1 7 2 7s1-2 1-5l1-5 1 3 3 11 2 2v-4l-1-8c0-4-3-7-9-10l-5-3-2-1c-2 0-6-4-6-6s4-1 7 1c2 2 3 2 4 0a31 31 0 0 1 8-6c9-6 19-14 17-16-2-4 14 5 21 12 6 5 4 8-2 3-6-4-7-4-8 1-1 10-3 16-5 17-1 1 0 7 2 7l3-6c1-3 3-7 5-8l4-5 3-1c2 1 2 2-1 5l-8 13-4 9 3 3c3 3 3 5 0 7l-2 2c1 3 0 4-4 4l-5 1-2 2c-2 0-3 1-3 2 1 2-2 3-3 2zm-72-8c0-2 6-5 8-5 3 0 2 3-1 3l-4 2h-3zm36-5c5-4 6-5 6-2l-5 4-5 3zm-8-5c-2-2-1-3 3-1 3 2 3 2 0 2l-3-1zm-2-7s2-2 5-2c2-1 6-3 7-5 3-3 5-4 5-2s-17 12-17 9z"></path></svg>
            <a href="https://ian.wold.guru/" class="h-card" rel="me">Ian Wold</a>
            <nav>
                <ul>
					<li><a  href="../about.html">About</a></li>
					<li><a  href="../now.html">Now</a></li>
					<li><a  href="../connect.html">Connect</a></li>
					<li><a href="https://buttondown.email/ianwold" target="_blank">Book Club</a></li>
                </ul>
            </nav>
        </header>
		<main>





<article class="h-entry">
	<header>
		<h1 class="p-name">Postgres: Use Views to Refactor to Soft Delete</h1>
		<section>
			<small>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
				5 October 2024
				<time class="dt-published" style="display: none;">
					2024-10-05T00:00:00.0000000Z
				</time>
			</small>
			<small>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
				18  Minutes 
			</small>
			<small>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"></circle><line x1="1.05" y1="12" x2="7" y2="12"></line><line x1="17.01" y1="12" x2="22.96" y2="12"></line></svg>
				<a href="https://github.com/IanWold/ianwold.github.io/commits/master/Site/Posts/postgres_use_views_to_refactor_to_soft_delete.md">History</a>
			</small>
			
				<small>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
					
						<a href="../Topics/databases.html">Databases</a>
					
						<a href="../Topics/postgres.html">Postgres</a>
					
						<a href="../Topics/how-to.html">How-To</a>
					
						<a href="../Topics/architecture.html">Architecture</a>
					
				</small>
			
		</section>
		<p class="p-summary">Refactors are tough, database refactors are scary. Being a bit clever can save us a lot of pain!</p>
		<img class="u-photo" alt="hero" src="https://images.unsplash.com/photo-1560506839-a23b986135a0?w=1000&h=525&fit=crop&crop=entropy" />
	</header>

	
		<nav>
			<ul>
				
				<li>
					<a href="#setting-up">
						
							<strong>Setting Up</strong>
						
					</a>
				</li>
				
				<li>
					<a href="#single-table">
						
							<strong>Single Table</strong>
						
					</a>
				</li>
				
				<li>
					<a href="#adding-the-deleted-flag">
						
							Adding the Deleted Flag
						
					</a>
				</li>
				
				<li>
					<a href="#hiding-deleted-data">
						
							Hiding Deleted Data
						
					</a>
				</li>
				
				<li>
					<a href="#make-deletes-not-delete">
						
							Make Deletes Not Delete
						
					</a>
				</li>
				
				<li>
					<a href="#accessing-deleted-records">
						
							Accessing Deleted Records
						
					</a>
				</li>
				
				<li>
					<a href="#separate-deleted-table">
						
							<strong>Separate Deleted Table</strong>
						
					</a>
				</li>
				
				<li>
					<a href="#adding-the-deleted-tables">
						
							Adding the Deleted Tables
						
					</a>
				</li>
				
				<li>
					<a href="#adding-the-combined-views">
						
							Adding the Combined Views
						
					</a>
				</li>
				
				<li>
					<a href="#make-delete-not-delete">
						
							Make Delete Not Delete
						
					</a>
				</li>
				
				<li>
					<a href="#accessing-deleted-records">
						
							Accessing Deleted Records
						
					</a>
				</li>
				
				<li>
					<a href="#conclusion">
						
							<strong>Conclusion</strong>
						
					</a>
				</li>
				
			</ul>
		</nav>
	
	

	<section class="e-content">
		<p><em>Author's note: I have updated this article with some extra bits of information as well as a repository demonstrating this solution. I hope this is helpful!</em></p>
<p>In the world of persistence, there's two main patterns (maybe &quot;groups of patterns&quot;) to handle deletion: <em>hard</em> and <em>soft</em> deletion. Hard deletion is the default for most database systems - when you &quot;delete&quot; a record it is wiped from the database; as soon as the delete is committed the data is gone forever. More common in most business scenarios - particularly server-side - is to retain the deleted data, just using a flag to hide the &quot;deleted&quot; data from the customer. This is soft deletion: it allows us to support more comprehensive internal reporting, maintain more complicated referential integrity, and we can support an &quot;undo&quot; button for our users.</p>
<p>If you're designing a system from the ground up and you know you need to accommodate soft deletion, there's a whole host of implementations you can tailor to your needs. If you're updating an existing system from hard to soft delete though, you're more constrained. Yes, the data that has already been hard deleted is irrecoverable after your migration, but that's not your main concern. You might have a lot of tables and there's probably already a lot of code written to query against these tables. This refactor might seem like a lot of work at first glance.</p>
<p>Luckily because <a href="https://ian.wold.guru/Posts/just_use_postgresql.html">you're definitely using Postgres</a>, this really isn't a major concern. There's a simple way using views and rules we can add soft deletion <em>without changing any of our queries</em>! In fact, there are two options which you might want to chose in different situations. I've implemented these strategies on a few production systems with zero downtime, and I'm sure you'll be able to make just as quick work of it as I can.</p>
<p>The first strategy keeps all records - those that are deleted and those that aren't - in a single table and uses a view to filter out deleted items. The second strategy adds a second table specifically for deleted items and uses a view to join the deleted and non-deleted records when needed. I have found the first option simpler to implement and maintain, while the second option is sometimes better in scenarios where I need to run a lot of different queries on the deleted vs. non-deleted data. These strategies could feasibly be combined in a single database, with some tables using one strategy and others the other, though consistency is probably better here.</p>
<p>I've set up <a href="https://github.com/IanWold/PostgresRefactorSoftDelete">a repository on GitHub</a> which runs both of these solutions on a database. If you're seriously considering implementing a migration like this, I would encourage you to fork and play with my repo, I hope it can be an effective way to tinker with some of these ideas before moving into an actual codebase. Throughout the article I'll reference where each bit of code is in this repo.</p>
<section id="setting-up">
<h2>Setting Up <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#setting-up">#</a></h2>
<p>I'm going to start by defining the existing system we're going to refactor. Let's consider a subset of an ecommerce system with tables <code>items</code>, <code>carts</code>, and of course <code>cart_items</code>:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> items (</span></div><div class='line'><span style="color: #F8F8F2;">    item_id </span><span style="color: #66D9EF;">SERIAL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">PRIMARY</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">KEY</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">name</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">VARCHAR</span><span style="color: #F8F8F2;">(</span><span style="color: #AE81FF;">255</span><span style="color: #F8F8F2;">) </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    price </span><span style="color: #F92672;">DECIMAL</span><span style="color: #F8F8F2;">(</span><span style="color: #AE81FF;">10</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">2</span><span style="color: #F8F8F2;">) </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    created </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> carts (</span></div><div class='line'><span style="color: #F8F8F2;">    cart_id </span><span style="color: #66D9EF;">SERIAL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">PRIMARY</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">KEY</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #66D9EF;">user_id</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">, </span><span style="color: #88846F;">-- I won&#39;t define this table</span></div><div class='line'><span style="color: #F8F8F2;">    created </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items (</span></div><div class='line'><span style="color: #F8F8F2;">    cart_item_id </span><span style="color: #66D9EF;">SERIAL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">PRIMARY</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">KEY</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    cart_id </span><span style="color: #F92672;">INT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    item_id </span><span style="color: #F92672;">INT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    quantity </span><span style="color: #F92672;">INT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NOT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">1</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    created </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_cart </span><span style="color: #F92672;">FOREIGN KEY</span><span style="color: #F8F8F2;"> (cart_id) </span><span style="color: #F92672;">REFERENCES</span><span style="color: #F8F8F2;"> carts (cart_id) </span><span style="color: #F92672;">ON DELETE CASCADE</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_item </span><span style="color: #F92672;">FOREIGN KEY</span><span style="color: #F8F8F2;"> (item_id) </span><span style="color: #F92672;">REFERENCES</span><span style="color: #F8F8F2;"> items (item_id) </span><span style="color: #F92672;">ON DELETE CASCADE</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L18'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L18</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE TABLE items (
    item_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE carts (
    cart_id SERIAL PRIMARY KEY,
    user_id INT NOT NULL, -- I won't define this table
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE cart_items (
    cart_item_id SERIAL PRIMARY KEY,
    cart_id INT NOT NULL,
    item_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_cart FOREIGN KEY (cart_id) REFERENCES carts (cart_id) ON DELETE CASCADE,
    CONSTRAINT fk_item FOREIGN KEY (item_id) REFERENCES items (item_id) ON DELETE CASCADE
);
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L18 [tl! autolink]
</textarea></code></pre>
<p>And we're going to need to support all the various queries currently written against these tables. In addition to all the queries <code>SELECT</code>ing from these tables, we're inserting, updating, and indeed deleting from each of these tables - those queries all need to remain the same.</p>
<p>There's a couple interesting queries I want to consider. Take the scenario where a cart is deleted:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> carts </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> cart_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> @cartId</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L139'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L139</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">DELETE FROM carts WHERE cart_id = @cartId
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L139 [tl! autolink]
</textarea></code></pre>
<p>In this case, it's pretty straightforward to assume that its items should delete at the same time, so we'll need to preserve the cascade functionality but with soft delete in mind. How about the following though:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> item_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> @itemId;</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L138'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L138</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">DELETE FROM items WHERE item_id = @itemId;
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/Program.cs#L138 [tl! autolink]
</textarea></code></pre>
<p>In our current production system, when we delete that item it will delete from the cart automatically. This is a good demonstration of why we care about soft delete - by preserving the data in our database we'll be able to tell the user that their dinner plate set is no longer available. Indeed, properly supporting that functionality is going to require some extra work in our code, but remember that <em>that</em> is a feature add: we can do our soft delete refactor and deploy it, preserving the current functionality with minimal effort. Later iterations can build on this work to add the new capabilities in.</p>
<p>This is the sort of planning work which needs to be done before beginning the refactor: The relationship between tables needs to be mapped out and understood. Typically you'll already have cascades set, so ideally this won't be difficult work to do.</p>
</section>
<section id="single-table">
<h2>Single Table <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#single-table">#</a></h2>
<p>This is the first strategy I'll discuss. To implement this, we'll go through a few discrete steps. First, we'll add a <code>deleted</code> flag to all of our tables, then we'll create a view for each table that excludes deleted records, and finally we'll update the definition of <code>DELETE</code> to perform the soft delete. Those views will effectively replace our tables for all queries and commands. After the refactor, deleted items can be queried directly from the original tables, which for all other purposes will have been &quot;hidden&quot; by the new views.</p>
<section id="adding-the-deleted-flag">
<h3>Adding the Deleted Flag <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#adding-the-deleted-flag">#</a></h3>
<p>The first step in our refactor will be to update every table we want to soft delete to add a new column. This will be the flag that determines whether the record is deleted or not. You can use just a boolean here, however this is an opportunity for us to capture more data and potentially make debugging a bit easier. I prefer using a nullable timestamp for my flag - <code>null</code> signifies it is <em>not</em> deleted, whereas the presence of a date indicates not only <em>that</em> it was deleted, but also <em>when</em>. Because soft deletion is commonly used to support internal reporting scenarios, this can sometimes be quite useful information.</p>
<p>Adding the column is quite straightforward of course, it can be added with no effect on the overall system:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> items </span><span style="color: #F92672;">ADD</span><span style="color: #F8F8F2;"> COLUMN deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> carts </span><span style="color: #F92672;">ADD</span><span style="color: #F8F8F2;"> COLUMN deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items </span><span style="color: #F92672;">ADD</span><span style="color: #F8F8F2;"> COLUMN deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L6'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L6</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">ALTER TABLE items ADD COLUMN deleted TIMESTAMP DEFAULT NULL;
ALTER TABLE carts ADD COLUMN deleted TIMESTAMP DEFAULT NULL;
ALTER TABLE cart_items ADD COLUMN deleted TIMESTAMP DEFAULT NULL;
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L6 [tl! autolink]
</textarea></code></pre>
<p>This can be deployed at any time and will not affect the rest of the system unless you're doing something squirrely with your tables. Just note though that if there's a long gap between your migration steps, new tables should have this column included. Because this column isn't used, it will be null for all records, and until we proceed to the next steps records will still be hard deleted.</p>
</section>
<section id="hiding-deleted-data">
<h3>Hiding Deleted Data <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#hiding-deleted-data">#</a></h3>
<p>This second step can also be deployed at any time after the first step with no change in the functionality of the system: we're going to hide any data where <code>deleted</code> is not null. In order to accomplish this without needing to rewrite any of our queries, constraints, or the like, we'll use views to achieve this.</p>
<p>For the unfamiliar, views act just like tables, but are essentially projections of other underlying tables and views. You define them with a <code>SELECT</code> statement just as you would query any other data. This allows you to marry commonly-referenced data together, but in our case we're going to use them a bit differently.</p>
<p>For <em>each</em> table which has a <code>deleted</code> column, we're going to define a new view which excludes the deleted values of the underlying column. Now, because we have how many references to the tables named <code>items</code>, <code>carts</code>, and <code>cart_items</code>, and it's <em>these</em> references from which we want to exclude the deleted items, we're going to give our views the names of the current tables and rename the current tables.</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> items RENAME </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> items_all;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW items </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_all </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">IS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> carts RENAME </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> carts_all;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW carts </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> carts_all </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">IS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items RENAME </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> cart_items_all;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW cart_items </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> cart_items_all </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">IS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">NULL</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L12'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L12</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">ALTER TABLE items RENAME TO items_all;
CREATE VIEW items AS SELECT * FROM items_all WHERE deleted IS NULL;
ALTER TABLE carts RENAME TO carts_all;
CREATE VIEW carts AS SELECT * FROM carts_all WHERE deleted IS NULL;
ALTER TABLE cart_items RENAME TO cart_items_all;
CREATE VIEW cart_items AS SELECT * FROM cart_items_all WHERE deleted IS NULL;
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L12 [tl! autolink]
</textarea></code></pre>
<p>Here I use the convention that the table name is suffixed &quot;_all&quot;, signifying of course that the tables contain &quot;all&quot; of the records. Your requirements might be different, so pick a naming convention that makes sense in the context. I recommend <a href="https://ian.wold.guru/Posts/its_better_to_be_consistently_incorrect_than_consistently_correct.html">being extremely consistent</a> here, and I also recommend picking a convention that is obvious in distinguishing the tables.</p>
<p>After deploying this update, you'll find that your system is still working exactly as it has in the past. Postgres passes any commands on these views down to the underlying table, so when you <code>INSERT</code> into one of these views, the data will be inserted into its respective table. Neat!</p>
</section>
<section id="make-deletes-not-delete">
<h3>Make Deletes Not Delete <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#make-deletes-not-delete">#</a></h3>
<p>This is the crucial step now: we need to redefine what a &quot;delete&quot; means. While the last two steps alter neither the behavior of the system nor the representation, this step will alter the representation of the data, and so long as we're dilligent it will not alter the behavior for your users. Because you're altering the data representation now though, be careful!</p>
<p>There's two steps we need to take here at once. First, we need to tell Postgres that when it gets a <code>DELETE</code> command for one of these tables that it actually needs to <em>update</em> the <code>deleted</code> column instead. Second, we need to define the new cascade behaviors to propogate the soft deletion in the intended way.</p>
<p>To redefine <code>DELETE</code>, Potgres allows us to create a <em>rule</em> to perform an alternate action <em>instead</em>. Typical for Postgres, this syntax is quite straightforward:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE rule_soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> items DO </span><span style="color: #F92672;">INSTEAD</span><span style="color: #F8F8F2;"> (</span><span style="color: #F92672;">UPDATE</span><span style="color: #F8F8F2;"> items_all </span><span style="color: #F92672;">SET</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> item_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">item_id</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE rule_soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> carts DO </span><span style="color: #F92672;">INSTEAD</span><span style="color: #F8F8F2;"> (</span><span style="color: #F92672;">UPDATE</span><span style="color: #F8F8F2;"> carts_all </span><span style="color: #F92672;">SET</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> cart_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE rule_soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> cart_items DO </span><span style="color: #F92672;">INSTEAD</span><span style="color: #F8F8F2;"> (</span><span style="color: #F92672;">UPDATE</span><span style="color: #F8F8F2;"> cart_items_all </span><span style="color: #F92672;">SET</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> cart_item_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_item_id</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L23'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L23</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE RULE rule_soft_delete AS ON DELETE TO items DO INSTEAD (UPDATE items_all SET deleted = CURRENT_TIMESTAMP WHERE item_id = OLD.item_id);
CREATE RULE rule_soft_delete AS ON DELETE TO carts DO INSTEAD (UPDATE carts_all SET deleted = CURRENT_TIMESTAMP WHERE cart_id = OLD.cart_id);
CREATE RULE rule_soft_delete AS ON DELETE TO cart_items DO INSTEAD (UPDATE cart_items_all SET deleted = CURRENT_TIMESTAMP WHERE cart_item_id = OLD.cart_item_id);
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L23 [tl! autolink]
</textarea></code></pre>
<p>And then we need to handle the cascades. Let's start with the simple case where we know that deleting a cart should cascade to each of its items. The rule we define will act on updates to the <code>carts_all</code> table and propogate new, non-null values for <code>deleted</code> to the cart items:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE rule_cascade_deleted_cart_items </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">UPDATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> carts_all</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">deleted</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">IS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DISTINCT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">NEW</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">deleted</span></div><div class='line'><span style="color: #F8F8F2;">    DO ALSO </span><span style="color: #F92672;">UPDATE</span><span style="color: #F8F8F2;"> cart_items_all </span><span style="color: #F92672;">SET</span><span style="color: #F8F8F2;"> deleted </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">NEW</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">deleted</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> cart_id </span><span style="color: #F92672;">=</span><span style="color: #F8F8F2;"> </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L27'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L27</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE RULE rule_cascade_deleted_cart_items AS ON UPDATE TO carts_all
    WHERE OLD.deleted IS DISTINCT FROM NEW.deleted
    DO ALSO UPDATE cart_items_all SET deleted = NEW.deleted WHERE cart_id = OLD.cart_id;
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L27 [tl! autolink]
</textarea></code></pre>
<p>Recall that the other cascade case, where we delete an item, is more complicated. The current behavior (which we are just trying to preserve for now) is that items are deleted from a cart when the items themselves are deleted. The state we want to achieve (some time after this migration) is that items will still show in the cart but as &quot;no longer available&quot;. That will take some extra coding to implement, however depending on the current state of our system we might be able to achieve some cost savings.</p>
<p>If you just want to keep the refactor simple or your system wouldn't currently support an alternate scheme, then you can implement the exact same rule but for items, then remove it later once you're ready. However, consider whether your current system would be able to do without the cascade right off the bat here. Suppose you have some logic on your cart page which attempts to get item data for all items in the cart and will not display items for which it cannot find data. In this case, you do not need to add the cascade, and the users will still observe the same behavior they currently have!</p>
<p>If you do decide not to carry over the cascade, there is the matter of the foreign key reference - if we soft delete a record from the <code>items_all</code> table, the foreign key on <code>cart_items.item_id</code> is still referencing the new <code>items</code> view and will break! In this case, we'll need to update the foreign key now:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-SQL"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items_all </span><span style="color: #F92672;">DROP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_item;</span></div><div class='line'><span style="color: #F92672;">ALTER</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items_all </span><span style="color: #F92672;">ADD</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_items_all </span><span style="color: #F92672;">FOREIGN KEY</span><span style="color: #F8F8F2;"> (item_id) </span><span style="color: #F92672;">REFERENCES</span><span style="color: #F8F8F2;"> items_all (item_id) </span><span style="color: #F92672;">ON DELETE CASCADE</span><span style="color: #F8F8F2;">;</span></div><textarea data-torchlight-original="true" style="display: none !important;">ALTER TABLE cart_items_all DROP CONSTRAINT fk_item;
ALTER TABLE cart_items_all ADD CONSTRAINT fk_items_all FOREIGN KEY (item_id) REFERENCES items_all (item_id) ON DELETE CASCADE;
</textarea></code></pre>
<p>Again, this step does <em>not</em> need to be done now if you are adding the manual cascade for <code>items</code>.</p>
</section>
<section id="accessing-deleted-records">
<h3>Accessing Deleted Records <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#accessing-deleted-records">#</a></h3>
<p>At this point, your migration is finished. Congratulations! In order to get records that have been deleted, you just need to query the <code>_all</code> table for that record:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_all </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> ...</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L37'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L37</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">SELECT * FROM items_all WHERE ...
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SingleTableMigration.cs#L37 [tl! autolink]
</textarea></code></pre>
<p>In order to hard delete any records, you can <code>DELETE</code> from the <code>_all</code> table:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_all </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> ...</span></div><textarea data-torchlight-original="true" style="display: none !important;">DELETE FROM items_all WHERE ...
</textarea></code></pre>
</section>
</section>
<section id="separate-deleted-table">
<h2>Separate Deleted Table <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#separate-deleted-table">#</a></h2>
<p>This is the second strategy, where deleted items are kept in separate tables. We'll also be able to work through some discrete steps to implement this. First, for each table we'll create a corresponding deleted table, and then we'll also create a corresponding view to unite the two. Finally, we'll alter the definition of <code>DELETE</code> to perform the soft delete. After the refactor, we'll be able to consult the separate deleted tables to work with our deleted records.</p>
<section id="adding-the-deleted-tables">
<h3>Adding the Deleted Tables <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#adding-the-deleted-tables">#</a></h3>
<p>The first step in our refactor will be to add a corresponding table for each existing table that will include the deleted fields. Instead of adding a <code>deleted</code> timestamp on the main table itself, it's sufficient for only this copy table to contain the field. We'll use <code>LIKE</code> to copy the schema of the base tables.</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> items_deleted (</span></div><div class='line'><span style="color: #F8F8F2;">    deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">LIKE</span><span style="color: #F8F8F2;"> items INCLUDING ALL</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> carts_deleted (</span></div><div class='line'><span style="color: #F8F8F2;">    deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">LIKE</span><span style="color: #F8F8F2;"> carts INCLUDING ALL</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items_deleted (</span></div><div class='line'><span style="color: #F8F8F2;">    deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">LIKE</span><span style="color: #F8F8F2;"> cart_items INCLUDING ALL</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L6'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L6</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE TABLE items_deleted (
    deleted TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LIKE items INCLUDING ALL
);
CREATE TABLE carts_deleted (
    deleted TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LIKE carts INCLUDING ALL
);
CREATE TABLE cart_items_deleted (
    deleted TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LIKE cart_items INCLUDING ALL
);
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L6 [tl! autolink]
</textarea></code></pre>
<p>My same note from earlier about naming conventions applies, though I think <code>_deleted</code> is probably the suffix 99% of us will ever use for these.</p>
<p>There is one issue with this snippet though - can you spot it? The problem is in <code>cart_items_deleted</code>: <code>LIKE ... INCLUDING ALL</code> will copy over the <em>entire</em> table schema, foreign key references included. In order to get around this, we'll need to not use <code>INCLUDING ALL</code> and manually copy over the foreign key constraints:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TABLE</span><span style="color: #F8F8F2;"> cart_items_deleted (</span></div><div class='line'><span style="color: #F8F8F2;">    deleted </span><span style="color: #F92672;">TIMESTAMP</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DEFAULT</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">CURRENT_TIMESTAMP</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">LIKE</span><span style="color: #F8F8F2;"> cart_items,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_cart </span><span style="color: #F92672;">FOREIGN KEY</span><span style="color: #F8F8F2;"> (cart_id) </span><span style="color: #F92672;">REFERENCES</span><span style="color: #F8F8F2;"> carts_deleted (cart_id) </span><span style="color: #F92672;">ON DELETE CASCADE</span><span style="color: #F8F8F2;">,</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">CONSTRAINT</span><span style="color: #F8F8F2;"> fk_item </span><span style="color: #F92672;">FOREIGN KEY</span><span style="color: #F8F8F2;"> (item_id) </span><span style="color: #F92672;">REFERENCES</span><span style="color: #F8F8F2;"> items_deleted (item_id) </span><span style="color: #F92672;">ON DELETE CASCADE</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE TABLE cart_items_deleted (
    deleted TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    LIKE cart_items,
    CONSTRAINT fk_cart FOREIGN KEY (cart_id) REFERENCES carts_deleted (cart_id) ON DELETE CASCADE,
    CONSTRAINT fk_item FOREIGN KEY (item_id) REFERENCES items_deleted (item_id) ON DELETE CASCADE
);
</textarea></code></pre>
<p>But wait, there's more! This works all well and good so long as the carts and items you're referencing from the <code>cart_items_deleted</code> table actually exist in <code>items_deleted</code> and <code>carts_deleted</code>. This is sure to not be the case, as it makes perfect sense that I might delete a cart item without that item having been deleted! Supposing that we <em>did</em> have a schema where we would expect the referant to be deleted also though, are we sure that <em>that</em> record is being deleted first?</p>
<p>This can all get quite tricky. If you don't care about the referential integrity of your soft-delted data (but trust me, you probably <em>should</em>), then you can just forego the foreign key constraints. If you do care about the references though, then you'll need to spend some time thinking about the best approach here. A whole article can be written on potential approaches so I won't distract us here, but beware of this trap!</p>
<p>This demonstrates the extra complexity of this second approach. It allows for a greater separation between deleted and non-deleted items, though it's important to consider which functionality and level of complexity your system requires.</p>
</section>
<section id="adding-the-combined-views">
<h3>Adding the Combined Views <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#adding-the-combined-views">#</a></h3>
<p>There are inevitably operations we're going to want to perform on the whole dataset for each table - deleted <em>and</em> non-deleted items all as one. To facilitate this, we'll create a view for each table/deleted table pair which unions the two:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW items_combined </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">null</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> deleted, </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items </span><span style="color: #F92672;">UNION ALL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_deleted;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW carts_combined </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">null</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> deleted, </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> carts </span><span style="color: #F92672;">UNION ALL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> carts_deleted;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> VIEW cart_items_combined </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">null</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> deleted, </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> cart_items </span><span style="color: #F92672;">UNION ALL</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> cart_items_deleted;</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L23'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L23</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE VIEW items_combined AS SELECT null AS deleted, * FROM items UNION ALL SELECT * FROM items_deleted;
CREATE VIEW carts_combined AS SELECT null AS deleted, * FROM carts UNION ALL SELECT * FROM carts_deleted;
CREATE VIEW cart_items_combined AS SELECT null AS deleted, * FROM cart_items UNION ALL SELECT * FROM cart_items_deleted;
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L23 [tl! autolink]
</textarea></code></pre>
<p>At least that's easy!</p>
</section>
<section id="make-delete-not-delete">
<h3>Make Delete Not Delete <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#make-delete-not-delete">#</a></h3>
<p>In order to make <code>DELETE</code>s perform a soft delete in this setup, we need to do a couple things when deleting: first, we need to copy the record into the respective <code>_deleted</code> table, then we need to allow the delete to actually happen.</p>
<p>Here we have a couple options. We could use a <code>RULE</code>...<code>DO ALSO</code> to perform the insert after the delete:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> items DO ALSO (</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> items_deleted (item_id, </span><span style="color: #F92672;">name</span><span style="color: #F8F8F2;">, price, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">name</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">price</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> carts DO ALSO (</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> carts_deleted (cart_id, </span><span style="color: #66D9EF;">user_id</span><span style="color: #F8F8F2;">, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">user_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> RULE soft_delete </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">TO</span><span style="color: #F8F8F2;"> cart_items DO ALSO (</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> cart_items_deleted (cart_item_id, cart_id, item_id, quantity, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">quantity</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">)</span></div><div class='line'><span style="color: #F8F8F2;">);</span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE RULE soft_delete AS ON DELETE TO items DO ALSO (
    INSERT INTO items_deleted (item_id, name, price, created)
    VALUES (OLD.item_id, OLD.name, OLD.price, OLD.created)
);
CREATE RULE soft_delete AS ON DELETE TO carts DO ALSO (
    INSERT INTO carts_deleted (cart_id, user_id, created)
    VALUES (OLD.cart_id, OLD.user_id, OLD.created)
);
CREATE RULE soft_delete AS ON DELETE TO cart_items DO ALSO (
    INSERT INTO cart_items_deleted (cart_item_id, cart_id, item_id, quantity, created)
    VALUES (OLD.cart_item_id, OLD.cart_id, OLD.item_id, OLD.quantity, OLD.created)
);
</textarea></code></pre>
<p>However, because we're combining operations I would tend towards preferring a trigger in this specific scenario:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">OR</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">REPLACE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> items_soft_delete() </span><span style="color: #F92672;">RETURNS</span><span style="color: #F8F8F2;"> TRIGGER </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> $$</span></div><div class='line'><span style="color: #F92672;">BEGIN</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> items_deleted (item_id, </span><span style="color: #F92672;">name</span><span style="color: #F8F8F2;">, price, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">name</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">price</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">RETURN</span><span style="color: #F8F8F2;"> OLD;</span></div><div class='line'><span style="color: #F92672;">END</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F8F8F2;">$$ </span><span style="color: #F92672;">LANGUAGE</span><span style="color: #F8F8F2;"> plpgsql;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> TRIGGER trigger_items_delete </span><span style="color: #F92672;">BEFORE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON</span><span style="color: #F8F8F2;"> items FOR EACH </span><span style="color: #F92672;">ROW</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">EXECUTE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> items_soft_delete();</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">OR</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">REPLACE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> carts_soft_delete() </span><span style="color: #F92672;">RETURNS</span><span style="color: #F8F8F2;"> TRIGGER </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> $$</span></div><div class='line'><span style="color: #F92672;">BEGIN</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> carts_deleted (cart_id, </span><span style="color: #66D9EF;">user_id</span><span style="color: #F8F8F2;">, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">user_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">RETURN</span><span style="color: #F8F8F2;"> OLD;</span></div><div class='line'><span style="color: #F92672;">END</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F8F8F2;">$$ </span><span style="color: #F92672;">LANGUAGE</span><span style="color: #F8F8F2;"> plpgsql;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> TRIGGER trigger_carts_delete </span><span style="color: #F92672;">BEFORE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON</span><span style="color: #F8F8F2;"> carts FOR EACH </span><span style="color: #F92672;">ROW</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">EXECUTE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> carts_soft_delete();</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">OR</span><span style="color: #F8F8F2;"> </span><span style="color: #66D9EF;">REPLACE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> cart_items_soft_delete() </span><span style="color: #F92672;">RETURNS</span><span style="color: #F8F8F2;"> TRIGGER </span><span style="color: #F92672;">AS</span><span style="color: #F8F8F2;"> $$</span></div><div class='line'><span style="color: #F92672;">BEGIN</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">INSERT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">INTO</span><span style="color: #F8F8F2;"> cart_items_deleted (cart_item_id, cart_id, item_id, quantity, created)</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">VALUES</span><span style="color: #F8F8F2;"> (</span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">cart_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">item_id</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">quantity</span><span style="color: #F8F8F2;">, </span><span style="color: #AE81FF;">OLD</span><span style="color: #F8F8F2;">.</span><span style="color: #AE81FF;">created</span><span style="color: #F8F8F2;">);</span></div><div class='line'><span style="color: #F8F8F2;">    </span><span style="color: #F92672;">RETURN</span><span style="color: #F8F8F2;"> OLD;</span></div><div class='line'><span style="color: #F92672;">END</span><span style="color: #F8F8F2;">;</span></div><div class='line'><span style="color: #F8F8F2;">$$ </span><span style="color: #F92672;">LANGUAGE</span><span style="color: #F8F8F2;"> plpgsql;</span></div><div class='line'><span style="color: #F92672;">CREATE</span><span style="color: #F8F8F2;"> TRIGGER trigger_cart_items_delete </span><span style="color: #F92672;">BEFORE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">DELETE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">ON</span><span style="color: #F8F8F2;"> items FOR EACH </span><span style="color: #F92672;">ROW</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">EXECUTE</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FUNCTION</span><span style="color: #F8F8F2;"> cart_items_soft_delete();</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L29'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L29</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">CREATE OR REPLACE FUNCTION items_soft_delete() RETURNS TRIGGER AS $
BEGIN
    INSERT INTO items_deleted (item_id, name, price, created)
    VALUES (OLD.item_id, OLD.name, OLD.price, OLD.created);
    RETURN OLD;
END;
$ LANGUAGE plpgsql;
CREATE TRIGGER trigger_items_delete BEFORE DELETE ON items FOR EACH ROW EXECUTE FUNCTION items_soft_delete();
CREATE OR REPLACE FUNCTION carts_soft_delete() RETURNS TRIGGER AS $
BEGIN
    INSERT INTO carts_deleted (cart_id, user_id, created)
    VALUES (OLD.cart_id, OLD.user_id, OLD.created);
    RETURN OLD;
END;
$ LANGUAGE plpgsql;
CREATE TRIGGER trigger_carts_delete BEFORE DELETE ON carts FOR EACH ROW EXECUTE FUNCTION carts_soft_delete();
CREATE OR REPLACE FUNCTION cart_items_soft_delete() RETURNS TRIGGER AS $
BEGIN
    INSERT INTO cart_items_deleted (cart_item_id, cart_id, item_id, quantity, created)
    VALUES (OLD.cart_item_id, OLD.cart_id, OLD.item_id, OLD.quantity, OLD.created);
    RETURN OLD;
END;
$ LANGUAGE plpgsql;
CREATE TRIGGER trigger_cart_items_delete BEFORE DELETE ON items FOR EACH ROW EXECUTE FUNCTION cart_items_soft_delete();
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L29 [tl! autolink]
</textarea></code></pre>
<p>You then have the same considerations regarding cascades and foreign key references as you had in the last refactor option. I'll leave that as an exercise for you to extend the trigger functions to include that behavior.</p>
</section>
<section id="accessing-deleted-records">
<h3>Accessing Deleted Records <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#accessing-deleted-records">#</a></h3>
<p>This is either the benefit or the drawback of this setup compared to the first scheme. In order to access deleted records, you query the <code>_deleted</code> table:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_deleted </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> ...</span></div><div class='line'><span style="color: #88846F;">-- <a target='_blank' rel='noopener' class='torchlight-link' style='color: #88846F;' href='https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L58'>https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L58</a> </span></div><textarea data-torchlight-original="true" style="display: none !important;">SELECT * FROM items_deleted WHERE ...
-- https://github.com/IanWold/PostgresRefactorSoftDelete/blob/main/SeparateTableMigration.cs#L58 [tl! autolink]
</textarea></code></pre>
<p>And of course all records together from the separate view:</p>
<pre class="torchlight" style="background-color: #272822; --theme-selection-background: #878b9180;" data-torchlight-processed="3449c9e5e332f1dbb81505cd739fbf3f"><code class="language-sql"><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F92672;">SELECT</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">*</span><span style="color: #F8F8F2;"> </span><span style="color: #F92672;">FROM</span><span style="color: #F8F8F2;"> items_combined </span><span style="color: #F92672;">WHERE</span><span style="color: #F8F8F2;"> ...</span></div><textarea data-torchlight-original="true" style="display: none !important;">SELECT * FROM items_combined WHERE ...
</textarea></code></pre>
<p>If your application will need to regard these three sets differently in distinct queries, then this setup is advantageous: there's less chance of writing the queries incorrectly and causing bugs. However, if you do need to consult the blended data or perform mostly the same queries, the first option might be better.</p>
</section>
</section>
<section id="conclusion">
<h2>Conclusion <a class="section-link" href="https://ian.wold.guru/Posts/postgres_use_views_to_refactor_to_soft_delete.html#conclusion">#</a></h2>
<p>Implementing soft delete on an existing system can seem like an exceptionally daunting task if you consider it from the perspective of needing to rewrite whole swaths of existing queries to suppot it. Not to mention, the incidence rate of bugs from such a hands-on refactor will be quite high!</p>
<p>The less we can touch our system during a refactor, the better. As with any refactor, this one requires some careful planning up front to understand the relationships between tables as data is deleted. Once that's understood, the refactor can proceed really quite fast <em>just</em> by changing the database schema, preserving the existing functionality and, crucially, the existing queries <em>and</em> the underlying semantics of those queries.</p>
<p>This doesn't absolve you of the careful work in ensuring your refactor works correctly (doubly so as you're tinkering around in the persistence). However, it does put more guardrails in place. Being able to move quickly <em>and</em> deliberately, touching as little as possible, leaves you in the best position for success in your refactor.</p>
</section>

	</section>

	<footer>
		<div id="webmentions"></div>
	
		<div class="comments">
			<script src="https://giscus.app/client.js"
				data-repo="IanWold/ianwold.github.io"
				data-repo-id="MDEwOlJlcG9zaXRvcnkxNTk1NDkyNzI="
				data-category="Posts"
				data-category-id="DIC_kwDOCYKHWM4CZH2Y"
				data-mapping="title"
				data-strict="0"
				data-reactions-enabled="0"
				data-emit-metadata="0"
				data-input-position="top"
				data-theme="light"
				data-lang="en"
				data-loading="lazy"
				crossorigin="anonymous"
				async>
			</script>
		</div>
	</footer>
</article>
<footer>
	<section>
		<img src="../images/hero1.svg" />
		<section>
			<h2>
				Hi, I'm Ian
			</h2>
			<p>
				I'm a software engineer, architect, and team leader in Minneapolis. My career has largely focused on .NET and web technologies, spread across several industries. Currently I'm working for Crate &amp; Barrel on their ecommerce solutions. You can find me on this blog, contributing to open source repositories, and at conferences around the Midwest.
			</p>
			<hr>
			<p>
				If you'd like to keep up with me, please subscribe to my <a href="https://buttondown.email/ianwold" target="_blank">book club</a> or <a href="https://ian.wold.guru/feed.xml" target="_blank">RSS feed</a>. If you'd like to help me out with server costs, I would be forever grateful if you <a href="https://ko-fi.com/ianwold">bought me a coffee</a>!
			</p>
			<hr>
			<p>
				Some other posts you might be interested in:
			</p>
			<ul>
				
					<li>
						<a href="../Posts/write_your_own_rdbms_versioned_migration_boilerplate.html">
							<h3>Write Your Own RDBMS Versioned Migration Boilerplate</h3>
							<small>Versioned migrations are an essential tool for systems using an RDBMS, and it's no work at all to start your applications the right way with this pattern.</small>
						</a>
					</li>
				
					<li>
						<a href="../Posts/just_use_postgresql.html">
							<h3>Just Use PostgreSQL</h3>
							<small>With a vast and growing ecosystem of database systems, data models, patterns, and paradigms, choosing the right one can be a long and complicated process. I prefer a simpler approach: Just use PostgreSQL.</small>
						</a>
					</li>
				
					<li>
						<a href="../Posts/learn_the_old_languages.html">
							<h3>Learn the Old Languages</h3>
							<small>New languages are hip, old languages are erudite. Don't neglect these languages as you round out your skills.</small>
						</a>
					</li>
				
			</ul>
		</section>
	</section>
</footer>

<script>
	const nav = document.querySelector('main nav');
	if (nav) {
		nav.style.setProperty('--element-height', `${nav.offsetHeight}px`);
	}

    document.addEventListener('DOMContentLoaded', function() {
        fetch(`https://webmention.io/api/mentions.jf2?target=${window.location.href}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Ope!`);
            }

            return response.json();
        })
        .then(json => {
            const mentionList = document.createElement('ul');

            json.children.forEach(child => {
                const date = new Date(child.published);
                const formattedDate = date.toLocaleDateString("en-GB", {
                    day: "2-digit",
                    month: "long",
                    year: "numeric"
                });

                var itemHtml = document.createElement('li');
                itemHtml.innerHTML = `<a href="${child.url}">${child.author.name} on ${formattedDate}</a>`;
                mentionList.appendChild(itemHtml);
            });

			const webmentionsDiv = document.getElementById('webmentions');

            if (mentionList.children.length > 0) {
                webmentionsDiv.innerHTML = '<section><p><strong>This post has been webmentioned by:</strong></p></section>';
                console.log(webmentionsDiv.firstChild.firstChild);
                webmentionsDiv.firstChild.firstChild.appendChild(mentionList);
            } else {
				webmentionsDiv.remove();
			}
        });
    });
</script>
		</main>
		<footer>
			<section>
				<span>
					Copyright © Ian Wold. Built with <a href="https://www.github.com/IanWold/Metalsharp">Metalsharp</a>, <a href="https://torchlight.dev">Torchlight</a>, and <a href="https://ian.wold.guru/built_with.html">many more cool things</a>.
				</span>
				<ul>
					<li><a href="https://github.com/ianwold" rel="me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></li>
					<li><a href="mailto:ian@wold.guru?subject=Hello" rel="me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></li>
					<li><a href="https://ko-fi.com/ianwold" target="_blank" rel="me"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-coffee"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg></a></li>
					<li><a href="https://buttondown.email/ianwold" target="_blank" rel="me"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></a></li>
					<li><a href="https://ian.wold.guru/feed.xml" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li>
				</ul>
			</section>
		</footer>

		<script>
			
				window.addEventListener('DOMContentLoaded', () => {
					const observer = new IntersectionObserver(entries => {
						entries.forEach(entry => {
							const id = entry.target.getAttribute('id');
							let classList = document.querySelector(`main nav li a[href="#${id}"]`).parentElement.classList;

							if (entry.intersectionRatio > 0) {
								classList.add('active');
							} else {
								classList.remove('active');
							}
						});
					});

					document.querySelectorAll('section[id]').forEach((section) => {
						observer.observe(section);
					});
				});
			

			const darkModeToggle = document.getElementById("dark-mode-toggle");
			const body = document.body;

			function toggleDarkMode() {
				body.classList.toggle("dark");

				if (localStorage.getItem("dark") === "enabled") {
					localStorage.setItem("dark", "disabled");
				} else {
					localStorage.setItem("dark", "enabled");
				}
			}

			darkModeToggle.addEventListener("click", toggleDarkMode);

			if (localStorage.getItem("dark") === "enabled") {
				body.classList.toggle("dark");
			}
		</script>
	</body>
</html>
